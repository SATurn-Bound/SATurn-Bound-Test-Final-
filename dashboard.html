<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>saturnbound | Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="images/Logo.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-grad:linear-gradient(180deg,#fbfdff 0%,#eef4fa 45%,#e6eef7 100%);
  --panel:rgba(255,255,255,.72);
  --panel-solid:#fff;
  --border:rgba(0,0,0,.08);
  --shadow:0 20px 40px -18px rgba(0,0,0,.18);
  --shadow-sm:0 8px 20px -10px rgba(0,0,0,.15);
  --accent:#2f62ff;
  --accent-alt:#f27891;
  --good:#1a9852;
  --warn:#e9ab17;
  --bad:#d63838;
  --muted:#5c6d80;
  --radius-lg:34px;--radius:24px;--radius-sm:12px;
  --ring:#2f62ff;
  --ring-glow:rgba(47,98,255,.5);
  --badge-bg:#eef3fb;
  --font-stack:'Inter',system-ui,Arial,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:var(--font-stack);
  background:var(--bg-grad);
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
  color:#0f1e33;
  padding-top:72px;
  line-height:1.35;
}
a{text-decoration:none;color:inherit}

/* Header */
header{
  position:fixed;top:0;left:0;width:100%;z-index:800;
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(18px) saturate(180%);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:.65rem 1.3rem;
}
.brand{display:flex;align-items:center;gap:.65rem;font-weight:700;font-size:1.05rem;letter-spacing:.5px}
.brand img{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 4px 10px rgba(0,0,0,.15)}
nav{display:flex;gap:1.2rem;font-size:.85rem;font-weight:500;flex-wrap:wrap}
nav a{padding:.45rem .85rem;border-radius:999px;transition:background .25s}
nav a:hover{background:rgba(0,0,0,.05)}
nav a.active{background:#2f62ff;color:#fff}

/* Layout */
main{max-width:1500px;margin:0 auto;padding:2.2rem 1.5rem 4rem;display:flex;flex-direction:column;gap:2.2rem}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:1.8rem;align-items:start}

.panel{
  background:var(--panel);
  backdrop-filter:blur(24px) saturate(180%);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.25rem 1.35rem 1.4rem;
  box-shadow:var(--shadow-sm);
  display:flex;flex-direction:column;gap:1.05rem;
  position:relative;overflow:hidden;
}
.panel h3{
  margin:0;font-size:1rem;font-weight:700;letter-spacing:.4px;
  display:flex;align-items:center;gap:.6rem;
}
.panel h3 .sub{font-weight:500;font-size:.7rem;letter-spacing:.1em;color:var(--muted);margin-left:auto;text-transform:uppercase}
.small-label{font-size:.58rem;font-weight:700;letter-spacing:.15em;color:var(--muted);text-transform:uppercase}

/* Gauges */
.gauge-wrap{display:flex;gap:1.2rem;flex-wrap:wrap}
.score-gauge{
  width:150px;height:150px;position:relative;
}
.score-gauge svg{transform:rotate(-90deg)}
.score-gauge circle{fill:none;stroke-width:14;stroke-linecap:round}
.gauge-bg{stroke:#e2e9f1}
.gauge-val{stroke:url(#gradScore);stroke-dasharray:520;stroke-dashoffset:520;transition:stroke-dashoffset 1.1s cubic-bezier(.4,.8,.3,1)}
.gauge-center{
  position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.gauge-center .big{font-size:1.75rem;font-weight:700;letter-spacing:.5px}
.gauge-center span{font-size:.65rem;letter-spacing:.1em;color:var(--muted);margin-top:2px}

.metric-row{display:flex;flex-wrap:wrap;gap:.9rem}
.metric{
  flex:1 1 140px;min-width:140px;
  display:flex;flex-direction:column;gap:.4rem;
  background:#fff;border:1px solid #e6edf4;border-radius:18px;padding:.75rem .85rem;
  box-shadow:0 4px 14px -6px rgba(0,0,0,.08);
}
.metric strong{font-size:1.2rem;font-weight:700}
.metric span{font-size:.6rem;font-weight:600;letter-spacing:.13em;color:var(--muted)}

.progress-bar{height:9px;background:#e3ebf3;border-radius:6px;position:relative;overflow:hidden}
.progress-bar span{position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,#2f62ff,#f27891);transition:width .9s}

/* Difficulty pills */
.pills{display:flex;flex-wrap:wrap;gap:.45rem}
.pill{
  background:#eef3fb;color:#1f2e44;
  padding:.45rem .65rem;font-size:.6rem;font-weight:600;border-radius:999px;
  border:1px solid #d7e2ec;letter-spacing:.05em;
}

/* Planet Progression */
.planet-card{display:flex;flex-direction:column;gap:1rem;align-items:center;text-align:center}
#planetCanvas{width:220px;height:220px;}
.ring-progress-bar{height:8px;background:#e2e9f0;border-radius:6px;overflow:hidden;width:100%;position:relative}
.ring-progress-bar span{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,#2f62ff,#f27891);width:0;transition:width .9s}
.ring-info{font-size:.65rem;color:var(--muted);line-height:1.35}

.badges{display:flex;flex-wrap:wrap;gap:.55rem;margin-top:.25rem}
.badge{
  display:inline-flex;align-items:center;gap:.35rem;
  padding:.45rem .6rem;background:var(--badge-bg);border:1px solid #d8e3ef;
  border-radius:14px;font-size:.55rem;font-weight:600;letter-spacing:.08em;
  position:relative;cursor:help;
}
.badge.good{background:#e1f8ec;border-color:#c4ecd6;color:#075a2d}
.badge.warn{background:#fff3d7;border-color:#f1dc9f;color:#8a6200}
.badge.perf{background:#f7dff6;border-color:#eeb9eb;color:#7c2c73}

/* Skill bars */
.skill-row{display:flex;flex-direction:column;gap:.35rem;margin-bottom:.55rem}
.skill-label{display:flex;justify-content:space-between;font-size:.62rem;font-weight:600;color:#1f2e44;letter-spacing:.08em}
.skill-bar{height:8px;background:#e1e9f2;border-radius:5px;overflow:hidden;position:relative}
.skill-bar span{position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,#2f62ff,#f27891);width:0;transition:width 1s}

/* Attempts table */
.table-wrap{overflow:auto;max-height:340px}
table{border-collapse:collapse;width:100%;font-size:.65rem;min-width:560px}
thead{background:#f3f7fb}
th,td{padding:.55rem .7rem;text-align:left;border-bottom:1px solid #e4ebf2}
tbody tr:nth-child(even){background:#fafcfe}
tbody tr:hover{background:#eef3fb}
.filter-row{display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:.35rem}
select,button.small-btn{
  font:inherit;font-size:.62rem;font-weight:600;letter-spacing:.05em;
  padding:.45rem .7rem;border-radius:10px;
  border:1px solid #d3dde7;background:#fff;color:#1c2d45;cursor:pointer;
  transition:background .25s;
}
button.small-btn:hover,select:hover{background:#f1f5fa}

/* Study Plan */
#studyPlanEditor{
  min-height:190px;
  background:#fff;
  border:1px solid #d8e1eb;
  border-radius:18px;
  padding:1rem 1rem;
  font-size:.85rem;
  line-height:1.45;
  box-shadow:0 6px 18px -8px rgba(0,0,0,.12);
  outline:none;
  overflow:auto;
}
#studyPlanEditor:empty:before{content:"Create or refine your weekly plan…";opacity:.5}
.plan-actions{display:flex;flex-wrap:wrap;gap:.55rem}
.plan-actions button{
  background:#fff;border:1px solid #d3dde7;
  padding:.5rem .9rem;font-size:.62rem;font-weight:600;
  border-radius:12px;cursor:pointer;letter-spacing:.05em;
  transition:background .25s;
}
.plan-actions button:hover{background:#f2f6fa}

/* Focus pills */
.focus-pills{display:flex;flex-wrap:wrap;gap:.5rem}
.focus-pill{
  background:#eef3fb;
  border:1px solid #d8e2ec;
  padding:.4rem .65rem;
  border-radius:12px;
  font-size:.58rem;
  font-weight:600;
  letter-spacing:.08em;
}
.focus-pill.low{background:#ffe4e4;border-color:#f4c5c5;color:#7b0e0e}
.focus-pill.mid{background:#fff4dc;border-color:#f1dc9f;color:#744f00}
.focus-pill.good{background:#e2f8ed;border-color:#c4ecd6;color:#0e5d2e}

footer{text-align:center;padding:2.8rem 1rem 3.5rem;font-size:.6rem;color:var(--muted)}

/* Responsive narrow fix */
@media(max-width:520px){
  .gauge-wrap{justify-content:center}
  .score-gauge{width:130px;height:130px}
  .grid{grid-template-columns:1fr}
  nav{display:none}
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="images/Logo.png" alt="saturnbound logo">
    <span>saturnbound</span>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="practice-tests.html">Tests</a>
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="aboutus.html">Our Team</a>
    <a href="login.html">Log In</a>
  </nav>
</header>

<main>
  <div class="grid">

    <!-- Planet Progression -->
    <div class="panel" id="planetPanel">
      <h3>Planet Progress <span class="sub">Rings & Badges</span></h3>
      <div class="planet-card">
        <svg id="planetCanvas" viewBox="0 0 260 260" role="img" aria-label="Saturn progression">
          <!-- Planet body -->
          <defs>
            <radialGradient id="planetGrad" cx="50%" cy="40%" r="60%">
              <stop offset="0%" stop-color="#ffe9c9"/>
              <stop offset="55%" stop-color="#f7c88b"/>
              <stop offset="100%" stop-color="#e4aa52"/>
            </radialGradient>
            <linearGradient id="ringGrad" x1="0%" y1="50%" x2="100%" y2="50%">
              <stop offset="0%" stop-color="#2f62ff"/>
              <stop offset="100%" stop-color="#f27891"/>
            </linearGradient>
          </defs>
          <circle cx="130" cy="130" r="63" fill="url(#planetGrad)" stroke="#d89f49" stroke-width="2"></circle>
          <!-- Rings inserted dynamically -->
          <g id="ringsGroup"></g>
        </svg>
        <div class="ring-progress-bar"><span id="ringProgress"></span></div>
        <div class="ring-info" id="ringInfo">Loading ring data…</div>
        <div class="badges" id="badgesHolder"></div>
      </div>
    </div>

    <!-- Score Overview (Math + English) -->
    <div class="panel" id="scoresPanel">
      <h3>Section Scores <span class="sub">Math & English</span></h3>
      <div class="gauge-wrap">
        <!-- Math Gauge -->
        <div class="score-gauge">
          <svg width="150" height="150">
            <defs>
              <linearGradient id="gradScore" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#2f62ff"/>
                <stop offset="100%" stop-color="#f27891"/>
              </linearGradient>
            </defs>
            <circle class="gauge-bg" cx="75" cy="75" r="60"></circle>
            <circle class="gauge-val" id="mathGauge" cx="75" cy="75" r="60"></circle>
          </svg>
          <div class="gauge-center">
            <div class="big" id="mathScore">--</div>
            <span>MATH / 800</span>
          </div>
        </div>
        <!-- English Gauge -->
        <div class="score-gauge">
          <svg width="150" height="150">
            <circle class="gauge-bg" cx="75" cy="75" r="60"></circle>
            <circle class="gauge-val" id="engGauge" cx="75" cy="75" r="60"
                    style="stroke:url(#gradScore)"></circle>
          </svg>
          <div class="gauge-center">
            <div class="big" id="engScore">--</div>
            <span>ENG / 800</span>
          </div>
        </div>
      </div>

      <div class="metric-row">
        <div class="metric">
          <strong id="overallAcc">--%</strong>
          <span>Overall Weighted Accuracy</span>
          <div class="progress-bar"><span id="overallAccBar"></span></div>
        </div>
        <div class="metric">
          <strong id="attemptTotal">0</strong>
          <span>Total Attempts</span>
        </div>
        <div class="metric">
          <strong id="deltaMath">--</strong>
          <span>Math Δ</span>
        </div>
        <div class="metric">
          <strong id="deltaEng">--</strong>
          <span>Eng Δ</span>
        </div>
      </div>
      <div class="pills" id="diffPills"></div>
    </div>

    <!-- Focus -->
    <div class="panel" id="focusPanel">
      <h3>Today's Focus <span class="sub">Weakest Skills</span></h3>
      <div class="focus-pills" id="focusSkills">Not enough data yet.</div>
      <button class="small-btn" id="refreshFocus">Recalculate</button>
      <p style="font-size:.6rem;color:var(--muted);margin-top:.3rem;">Weakest 3 skills (combined Math + English weighted accuracy). Improve these to unlock rings faster.</p>
    </div>

    <!-- Skills Analytics -->
    <div class="panel" id="skillsPanel">
      <h3>Skill Accuracy <span class="sub">By Tag</span></h3>
      <div id="skillBars">Tag questions with <code>skill</code> in questionMeta to populate.</div>
    </div>

    <!-- Attempts History -->
    <div class="panel" id="attemptsPanel">
      <h3>Recent Attempts <span class="sub">History</span></h3>
      <div class="filter-row">
        <select id="sectionFilter">
          <option value="all">All Sections</option>
          <option value="math">Math</option>
          <option value="english">English</option>
        </select>
        <select id="limitFilter">
          <option value="6">Last 6</option>
          <option value="10">Last 10</option>
          <option value="25">Last 25</option>
          <option value="all">All</option>
        </select>
        <button class="small-btn" id="clearLocal">Clear Local Attempts</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Section</th><th>Test</th><th>Raw</th><th>Weighted%</th><th>Est Score</th><th>Missed</th>
            </tr>
          </thead>
          <tbody id="attemptsBody">
            <tr><td colspan="7" style="text-align:center;padding:1rem;color:var(--muted)">No attempts yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Study Plan -->
    <div class="panel" id="planPanel">
      <h3>Personal Study Plan <span class="sub">Editable</span></h3>
      <div id="studyPlanEditor" contenteditable="true"></div>
      <div class="plan-actions">
        <button id="btnSavePlan">Save Now</button>
        <button id="btnTemplate">Insert Template</button>
        <button id="btnPrintPlan">Print</button>
        <button id="btnClearPlan" style="color:#d63838">Clear</button>
      </div>
      <div style="font-size:.58rem;color:var(--muted);">Autosaves every 5s after edits. Last saved:
        <span id="planSavedTime">Never</span>
      </div>
    </div>

  </div>
</main>

<footer>&copy; saturnbound 2025. All rights reserved.</footer>

<script type="module">
/* ---------------- CONFIG ---------------- */
const WEIGHTS = { easy:1.0, medium:1.4, hard:1.8 };
const PENALIZE_MISSES = false;
const MAX_SCORE = 800;
const RING_THRESHOLDS = [10,25,40,55,70,85,95]; // cumulative S values (0..100 scale) for rings 1..7
// Lists of localStorage keys for math and english attempts
const ATTEMPT_KEYS_MATH = ['practiceTest2Results']; // add: 'practiceTest3Results', etc.
const ATTEMPT_KEYS_ENGLISH = ['readingTest1Results','readingTest2Results']; // create when you build them

/* ---------- Local Storage Load ---------- */
function loadAttempts(keys, sectionHint){
  const out=[];
  keys.forEach(k=>{
    const raw=localStorage.getItem(k);
    if(!raw) return;
    try{
      const d=JSON.parse(raw);
      out.push({
        key:k,
        date:new Date(d.timestamp||Date.now()),
        score:d.score,
        total:d.totalQuestions,
        answers:d.answers||{},
        meta:d.questionMeta||{},
        pct:(d.score/d.totalQuestions),
        section: sectionHint, // fallback
        testName:k.replace(/Results$/,'')
      });
    }catch(e){}
  });
  return out;
}
let mathAttempts = loadAttempts(ATTEMPT_KEYS_MATH,'math');
let engAttempts  = loadAttempts(ATTEMPT_KEYS_ENGLISH,'english');
let allAttempts = [...mathAttempts,...engAttempts]
  .sort((a,b)=>b.date - a.date);

/* ---------- Weighted Computation per Attempt ---------- */
function perAttemptWeighted(attempt){
  let totalW=0, correctW=0, incorrectW=0;
  Object.entries(attempt.answers).forEach(([qid,uAns])=>{
    const meta = attempt.meta[qid]||{};
    const diff=(meta.difficulty||'medium').toLowerCase();
    const weight=WEIGHTS[diff]||WEIGHTS.medium;
    const correct = meta.correct || uAns; // fallback if not stored
    totalW += weight;
    if(uAns===correct) correctW += weight; else incorrectW += weight;
  });
  if(totalW===0) return {ratio:0,est:0,totalW,correctW};
  let ratio = correctW/totalW;
  if(PENALIZE_MISSES){
    ratio = Math.max(0,(correctW-0.05*incorrectW)/totalW);
  }
  return {ratio,est:Math.round(MAX_SCORE*ratio),totalW,correctW};
}

/* ---------- Aggregate Section Stats ---------- */
function aggregateSection(section){
  const attempts = section==='math'? mathAttempts : engAttempts;
  if(!attempts.length) return {ratio:0,est:0,delta:null,attempts:0,last:null,prev:null};
  const latest=perAttemptWeighted(attempts[0]);
  const prev = attempts.length>1? perAttemptWeighted(attempts[1]) : null;
  const avgRatio = attempts.reduce((s,a)=>s+perAttemptWeighted(a).ratio,0)/attempts.length;
  return {
    ratio:avgRatio,
    est:Math.round(MAX_SCORE*avgRatio),
    delta: prev? (latest.est - prev.est) : null,
    attempts:attempts.length,
    last:latest,
    prev
  };
}
const mathAgg = aggregateSection('math');
const engAgg  = aggregateSection('english');

/* ---------- Combined Accuracy for Rings ---------- */
function overallWeightedAccuracy(){
  const all=[...mathAttempts,...engAttempts];
  if(!all.length) return 0;
  let totalW=0, correctW=0;
  all.forEach(a=>{
    const w=perAttemptWeighted(a);
    totalW+=w.totalW; correctW+=w.correctW;
  });
  return totalW? correctW/totalW : 0;
}

/* ---------- Populate Gauges & Metrics ---------- */
const circumference = 2*Math.PI*60;
function setGauge(el,ratio){
  el.style.strokeDasharray=circumference;
  el.style.strokeDashoffset = circumference*(1-ratio);
}
setGauge(document.getElementById('mathGauge'), mathAgg.ratio);
setGauge(document.getElementById('engGauge'), engAgg.ratio);

document.getElementById('mathScore').textContent = mathAgg.est? mathAgg.est : '--';
document.getElementById('engScore').textContent = engAgg.est? engAgg.est : '--';
document.getElementById('attemptTotal').textContent = allAttempts.length;

function fmtPct(p){return (p*100).toFixed(1)+'%';}
const overallAcc = overallWeightedAccuracy();
document.getElementById('overallAcc').textContent = fmtPct(overallAcc);
document.getElementById('overallAccBar').style.width = (overallAcc*100)+'%';

const deltaMathEl=document.getElementById('deltaMath');
const deltaEngEl=document.getElementById('deltaEng');
deltaMathEl.textContent = mathAgg.delta===null?'--': (mathAgg.delta>0? '+'+mathAgg.delta : mathAgg.delta);
deltaMathEl.style.color = mathAgg.delta>0? 'var(--good)': (mathAgg.delta<0? 'var(--bad)' : '#1f2e44');
deltaEngEl.textContent = engAgg.delta===null?'--': (engAgg.delta>0? '+'+engAgg.delta : engAgg.delta);
deltaEngEl.style.color = engAgg.delta>0? 'var(--good)': (engAgg.delta<0? 'var(--bad)' : '#1f2e44');

/* ---------- Difficulty Pills ---------- */
function difficultyBreakdown(){
  const diffTotals={}, diffCorrect={};
  [...mathAttempts,...engAttempts].forEach(a=>{
    Object.entries(a.answers).forEach(([qid,uAns])=>{
      const meta=a.meta[qid]||{};
      const diff=(meta.difficulty||'medium').toLowerCase();
      const w=WEIGHTS[diff]||WEIGHTS.medium;
      diffTotals[diff]=(diffTotals[diff]||0)+w;
      const correct=meta.correct||uAns;
      if(uAns===correct) diffCorrect[diff]=(diffCorrect[diff]||0)+w;
    });
  });
  const holder=document.getElementById('diffPills');
  holder.innerHTML='';
  Object.keys(WEIGHTS).forEach(d=>{
    const tot=diffTotals[d]; if(!tot) return;
    const pct=((diffCorrect[d]||0)/tot*100).toFixed(0);
    const pill=document.createElement('div');
    pill.className='pill';
    pill.textContent=d.charAt(0).toUpperCase()+d.slice(1)+': '+pct+'%';
    holder.appendChild(pill);
  });
}
difficultyBreakdown();

/* ---------- Skill Bars ---------- */
function buildSkills(){
  const skillsTotals={}, skillsCorrect={};
  [...mathAttempts,...engAttempts].forEach(a=>{
    Object.entries(a.answers).forEach(([qid,uAns])=>{
      const meta=a.meta[qid]||{};
      const skill = meta.skill || 'Untagged';
      const diff=(meta.difficulty||'medium').toLowerCase();
      const w=WEIGHTS[diff]||WEIGHTS.medium;
      skillsTotals[skill]=(skillsTotals[skill]||0)+w;
      const correct=meta.correct||uAns;
      if(uAns===correct) skillsCorrect[skill]=(skillsCorrect[skill]||0)+w;
    });
  });
  const wrap=document.getElementById('skillBars');
  wrap.innerHTML='';
  if(!Object.keys(skillsTotals).length){
    wrap.textContent='Tag questions with skill metadata to view accuracy breakdown.';
    return;
  }
  Object.keys(skillsTotals).sort().forEach(sk=>{
    const pct = (skillsCorrect[sk]||0)/skillsTotals[sk];
    const row=document.createElement('div');
    row.className='skill-row';
    row.innerHTML=`
      <div class="skill-label"><span>${sk}</span><span>${(pct*100).toFixed(0)}%</span></div>
      <div class="skill-bar"><span style="width:${(pct*100).toFixed(1)}%"></span></div>
    `;
    wrap.appendChild(row);
  });
}
buildSkills();

/* ---------- Focus Skills ---------- */
function buildFocusSkills(){
  const skillsTotals={}, skillsCorrect={};
  [...mathAttempts,...engAttempts].forEach(a=>{
    Object.entries(a.answers).forEach(([qid,uAns])=>{
      const meta=a.meta[qid]||{};
      const skill=meta.skill||'Untagged';
      const diff=(meta.difficulty||'medium').toLowerCase();
      const w=WEIGHTS[diff]||WEIGHTS.medium;
      skillsTotals[skill]=(skillsTotals[skill]||0)+w;
      const correct=meta.correct||uAns;
      if(uAns===correct) skillsCorrect[skill]=(skillsCorrect[skill]||0)+w;
    });
  });
  const holder=document.getElementById('focusSkills');
  holder.innerHTML='';
  const list=Object.keys(skillsTotals).map(sk=>{
    const pct=(skillsCorrect[sk]||0)/skillsTotals[sk];
    return {skill:sk,pct};
  }).sort((a,b)=>a.pct-b.pct);
  if(!list.length){holder.textContent='Not enough data yet.';return;}
  list.slice(0,3).forEach(item=>{
    const pill=document.createElement('div');
    pill.className='focus-pill '+(item.pct<.5?'low': item.pct<.75?'mid':'good');
    pill.textContent=item.skill+' • '+(item.pct*100).toFixed(0)+'%';
    holder.appendChild(pill);
  });
}
buildFocusSkills();
document.getElementById('refreshFocus').onclick=()=>{
  buildFocusSkills();
  buildSkills();
  difficultyBreakdown();
};

/* ---------- Attempts Table ---------- */
function renderAttempts(){
  const tbody=document.getElementById('attemptsBody');
  const sectionFilter=document.getElementById('sectionFilter').value;
  const limitVal=document.getElementById('limitFilter').value;
  tbody.innerHTML='';
  let filtered=allAttempts;
  if(sectionFilter!=='all')
    filtered=filtered.filter(a=>a.section===sectionFilter);

  if(limitVal!=='all')
    filtered=filtered.slice(0, +limitVal);

  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:1rem;color:var(--muted)">No attempts</td></tr>';
    return;
  }

  filtered.forEach(a=>{
    const w=perAttemptWeighted(a);
    const missed=a.total - a.score;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${a.date.toLocaleDateString()}</td>
      <td style="text-transform:capitalize">${a.section||'?'}</td>
      <td>${a.testName}</td>
      <td>${a.score}/${a.total}</td>
      <td>${(w.ratio*100).toFixed(1)}%</td>
      <td>${w.est}</td>
      <td>${missed}</td>
    `;
    tbody.appendChild(tr);
  });
}
renderAttempts();
document.getElementById('sectionFilter').onchange=renderAttempts;
document.getElementById('limitFilter').onchange=renderAttempts;

/* ---------- Clear Local Attempts ---------- */
document.getElementById('clearLocal').onclick=()=>{
  if(!confirm('Clear local attempt data?')) return;
  [...ATTEMPT_KEYS_MATH,...ATTEMPT_KEYS_ENGLISH].forEach(k=>localStorage.removeItem(k));
  mathAttempts=[]; engAttempts=[]; allAttempts=[];
  renderAttempts(); buildSkills(); buildFocusSkills(); difficultyBreakdown();
  document.getElementById('mathScore').textContent='--';
  document.getElementById('engScore').textContent='--';
};

/* ---------- Planet Rings Logic ---------- */
function computeRingStatus(){
  const combinedAcc = overallWeightedAccuracy(); // 0..1
  const totalAttempts = allAttempts.length;
  // Performance P (0..100)
  const P = combinedAcc*100;
  // Volume V (0..100) saturates at 12 attempts
  const V = Math.min(totalAttempts/12*100,100);
  const S = 0.75*P + 0.25*V;

  let rings = 0;
  for(let i=0;i<RING_THRESHOLDS.length;i++){
    if(S >= RING_THRESHOLDS[i]) rings=i+1; else break;
  }
  const nextThreshold = RING_THRESHOLDS[rings] || 100;
  const prevThreshold = rings? RING_THRESHOLDS[rings-1]:0;
  const progressSegment = (S - prevThreshold)/(nextThreshold - prevThreshold || 1);
  return {S,rings,nextThreshold,prevThreshold,progressSegment, combinedAcc, totalAttempts, P, V};
}
const ringStatus = computeRingStatus();

function drawRings(){
  const group=document.getElementById('ringsGroup');
  group.innerHTML='';
  // base rings: draw ringStatus.rings visible
  const maxRings=7;
  for(let i=1;i<=maxRings;i++){
    if(i>ringStatus.rings) break;
    const scale = 0.9 + i*0.06;
    const ring = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    ring.setAttribute('cx','130'); ring.setAttribute('cy','130');
    ring.setAttribute('rx', String(70*scale));
    ring.setAttribute('ry', String(24*scale));
    ring.setAttribute('fill','none');
    ring.setAttribute('stroke','url(#ringGrad)');
    ring.setAttribute('stroke-width','2.2');
    ring.setAttribute('opacity', (0.35 + i*0.08).toFixed(2));
    ring.setAttribute('filter','drop-shadow(0 0 4px rgba(47,98,255,.4))');
    group.appendChild(ring);
  }
}
drawRings();

document.getElementById('ringProgress').style.width = (ringStatus.progressSegment*100)+'%';
document.getElementById('ringInfo').innerHTML = `
  Rings: <strong>${ringStatus.rings}</strong> / 7<br>
  Score Index S: ${ringStatus.S.toFixed(1)} / 100<br>
  Next Ring at: ${ringStatus.rings===7?'MAX': ringStatus.nextThreshold} | Segment ${(ringStatus.progressSegment*100).toFixed(0)}%<br>
  <span style="opacity:.8">Perf (P) ${(ringStatus.P).toFixed(0)} • Volume (V) ${(ringStatus.V).toFixed(0)} • Attempts ${ringStatus.totalAttempts}</span>
`;

/* ---------- Badges ---------- */
function evaluateBadges(){
  const badges=[];
  const combinedAcc=overallWeightedAccuracy();
  const last5 = allAttempts.slice(0,5).map(a=>perAttemptWeighted(a).ratio*100);
  const stdDev = last5.length<3? 999 : (()=>{
     const m=last5.reduce((s,x)=>s+x,0)/last5.length;
     const v=last5.reduce((s,x)=>s+(x-m)**2,0)/last5.length;
     return Math.sqrt(v);
  })();
  const streak3 = allAttempts.slice(0,3).every(a=>perAttemptWeighted(a).ratio>=0.65);

  if(allAttempts.length>=1) badges.push({id:'first_attempt', label:'First Attempt', cls:'good', tip:'Completed your first practice set.'});
  if(mathAgg.est>=600) badges.push({id:'math_600', label:'Math 600+', cls:'good', tip:'Reached 600+ estimated Math score.'});
  if(engAgg.est>=600) badges.push({id:'eng_600', label:'Eng 600+', cls:'good', tip:'Reached 600+ estimated English score.'});
  if(mathAgg.est>=700 && engAgg.est>=700) badges.push({id:'dual_700', label:'Dual 700+', cls:'good', tip:'700+ in both sections.'});
  if(mathAgg.est===800 || engAgg.est===800) badges.push({id:'perfect_800_any', label:'800 Perfect', cls:'perf', tip:'Achieved a perfect section score estimate.'});
  if(streak3) badges.push({id:'streak_3', label:'3‑Streak', cls:'warn', tip:'Three recent attempts ≥65% weighted accuracy.'});
  if(combinedAcc>=0.80) badges.push({id:'accuracy_80', label:'80% Acc', cls:'good', tip:'Overall weighted accuracy ≥80%.'});
  if(stdDev<=5) badges.push({id:'consistency_low_var', label:'Consistent', cls:'warn', tip:'Low variance (≤5%) across last 5 attempts.'});

  return badges;
}

function renderBadges(){
  const holder=document.getElementById('badgesHolder');
  holder.innerHTML='';
  const badges=evaluateBadges();
  if(!badges.length){
    holder.innerHTML='<div style="font-size:.55rem;opacity:.6;">Earn badges by practicing!</div>';
    return;
  }
  badges.forEach(b=>{
    const div=document.createElement('div');
    div.className='badge '+b.cls;
    div.textContent=b.label;
    div.title=b.tip;
    holder.appendChild(div);
  });
}
renderBadges();

/* ---------- Study Plan ---------- */
const PLAN_KEY='dashboard_study_plan_v2';
const PLAN_TIME_KEY='dashboard_study_plan_saved_at';
const planEditor=document.getElementById('studyPlanEditor');
const planTime=document.getElementById('planSavedTime');

function loadPlan(){
  const saved=localStorage.getItem(PLAN_KEY);
  if(saved) planEditor.innerHTML=saved;
  const t=localStorage.getItem(PLAN_TIME_KEY);
  if(t) planTime.textContent=new Date(+t).toLocaleTimeString();
}
loadPlan();
let planDirty=false;
planEditor.addEventListener('input',()=>{planDirty=true;});
setInterval(()=>{if(planDirty) savePlan();},5000);

function savePlan(){
  localStorage.setItem(PLAN_KEY,planEditor.innerHTML);
  const now=Date.now();
  localStorage.setItem(PLAN_TIME_KEY,now);
  planTime.textContent=new Date(now).toLocaleTimeString();
  planDirty=false;
}
document.getElementById('btnSavePlan').onclick=savePlan;
document.getElementById('btnPrintPlan').onclick=()=>{
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>Study Plan</title>
  <style>body{font-family:Inter,Arial,sans-serif;padding:24px;line-height:1.5;font-size:15px;color:#111}h1{margin-top:0}</style></head>
  <body><h1>Study Plan</h1>${planEditor.innerHTML}</body></html>`);
  w.document.close();w.focus();w.print();
};
document.getElementById('btnTemplate').onclick=()=>{
  planEditor.innerHTML += `
  <h4>Weekly Cycle</h4>
  <ul>
    <li><strong>Mon:</strong> Weak Skill 1 (concept review + 10 targeted).</li>
    <li><strong>Tue:</strong> Weak Skill 2 + 5 mixed medium.</li>
    <li><strong>Wed:</strong> Full timed mini-set (20Q) tracking pace.</li>
    <li><strong>Thu:</strong> Data/Reading inference drills.</li>
    <li><strong>Fri:</strong> Hard set (focus accuracy) + error journal.</li>
    <li><strong>Sat:</strong> Full practice test.</li>
    <li><strong>Sun:</strong> Light review + adapt retest of misses.</li>
  </ul>
  <h4>Targets (Next 2 Weeks)</h4>
  <ul>
    <li>Raise weakest 3 skills to ≥65% weighted.</li>
    <li>Math est +40, English est +30.</li>
    <li>Maintain accuracy ≥55% on hard questions.</li>
  </ul>
  `;
  planDirty=true;
};
document.getElementById('btnClearPlan').onclick=()=>{
  if(confirm('Clear study plan content?')){planEditor.innerHTML='';savePlan();}
};

/* ---------- Clear attempts button already handled ---------- */

/* ---------- Expose for debugging (optional) ---------- */
window._saturnDebug={mathAttempts,engAttempts,ringStatus,overallAcc};

/* ---------- END ---------- */
</script>
</body>
</html>
