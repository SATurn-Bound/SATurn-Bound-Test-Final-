<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SATurn Bound | Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="images/Logo.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg-top:#e9f2ff;--bg-mid:#cfe2ff;--bg-btm:#b7d4ff;
  --text:#0d1117;--muted:#536274;
  --brand:#2156ff;--brand-dark:#133aa5;--accent-alt:#f27891;
  --panel:rgba(255,255,255,.65);--panel-border:rgba(255,255,255,.75);
  --panel-solid:#ffffff;
  --border-soft:rgba(0,0,0,.08);--border-mid:rgba(0,0,0,.14);
  --radius:26px;
  --shadow:0 12px 38px -18px rgba(21,42,90,.25);
  --shadow-small:0 4px 14px -6px rgba(21,42,90,.22);
  --progress-bg:rgba(0,0,0,.1);
  --grad-bar:linear-gradient(90deg,#2156ff,#6c89ff 45%,#f27891);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,Helvetica,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg-top)0%,var(--bg-mid)48%,var(--bg-btm)100%);
  color:var(--text);-webkit-font-smoothing:antialiased;
  padding-top:86px;line-height:1.42;
}
a{text-decoration:none;color:var(--brand)}
/* Header */
header{
  position:fixed;top:0;left:0;width:100%;z-index:900;
  padding:.75rem 1.6rem;display:flex;justify-content:space-between;align-items:center;
  background:rgba(255,255,255,.55);backdrop-filter:saturate(180%) blur(14px);
  border-bottom:1px solid rgba(255,255,255,.6);transition:box-shadow .3s;
}
header.scrolled{box-shadow:0 4px 14px -6px rgba(0,0,0,.18)}
.brand{display:flex;align-items:center;gap:.7rem;font-weight:700;font-size:1.05rem;letter-spacing:.03em}
.brand img{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 4px 10px rgba(0,0,0,.15)}
nav{display:flex;gap:1.05rem;font-size:.9rem;font-weight:600;color:var(--muted);flex-wrap:wrap}
nav a{padding:.45rem .85rem;border-radius:10px;color:var(--muted);transition:background .25s,color .25s}
nav a:hover{background:rgba(0,0,0,.06);color:#132238}
nav a.active{background:var(--brand);color:#fff;box-shadow:0 4px 12px -4px rgba(33,86,255,.4)}
@media(max-width:760px){nav{display:none}}
/* Layout */
main{max-width:1560px;margin:0 auto;padding:2.2rem 1.6rem 4.2rem;display:flex;flex-direction:column;gap:2rem}
.grid{
  display:grid;gap:1.55rem;
  grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
  align-items:start;
}
/* Panel */
.panel{
  background:var(--panel);backdrop-filter:blur(18px) saturate(170%);
  border:1px solid var(--panel-border);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:1.25rem 1.3rem 1.35rem;
  display:flex;flex-direction:column;gap:.9rem;position:relative;overflow:hidden;
}
.panel h3{margin:0;font-size:1.02rem;font-weight:700;letter-spacing:.4px;color:#102035;display:flex;align-items:center;gap:.6rem}
.panel h3 .sub{margin-left:auto;font-size:.6rem;font-weight:600;letter-spacing:.16em;color:var(--muted);text-transform:uppercase}
.small-label{font-size:.55rem;font-weight:700;letter-spacing:.15em;color:var(--muted);text-transform:uppercase}
/* Wizard */
#wizardOutput h4{margin:.9rem 0 .35rem;font-size:.82rem;font-weight:700;color:#132238}
#wizardOutput ul{margin:.25rem 0 .65rem .95rem;padding:0;font-size:.72rem}
#wizardOutput li{margin:0 0 .3rem}
#wizardOutput pre{background:#f3f7ff;border:1px solid #d5e2f2;padding:.7rem .8rem;border-radius:14px;font-family:ui-monospace,Consolas,monospace;font-size:.63rem;line-height:1.4;white-space:pre-wrap}
#wizardOutput .phaseTag{display:inline-block;font-size:.5rem;font-weight:700;letter-spacing:.15em;background:#2156ff18;color:var(--brand);padding:.35rem .55rem;border-radius:12px;margin-right:.4rem;text-transform:uppercase}
.wizard-inline{display:flex;flex-wrap:wrap;gap:.85rem}
.wizard-inline > div{flex:1 1 130px;min-width:130px}
.wizard-inline input{
  width:100%;padding:.55rem .7rem;border:1px solid var(--border-mid);
  border-radius:12px;font:inherit;background:#fff;font-size:.75rem;
}
#wizardButtons{display:flex;gap:.55rem;flex-wrap:wrap;margin-top:.2rem}
#wizardButtons button{
  flex:0 0 auto;padding:.65rem 1.05rem;font-size:.58rem;font-weight:600;letter-spacing:.12em;
  border:1px solid var(--border-mid);background:#fff;color:#15315d;
  border-radius:14px;cursor:pointer;transition:background .25s,box-shadow .25s;
  text-transform:uppercase;
}
#wizardButtons button.primary{background:var(--brand);color:#fff;border:none;box-shadow:0 4px 14px -6px rgba(33,86,255,.45)}
#wizardButtons button.primary:hover{background:var(--brand-dark)}
#wizardButtons button:disabled{opacity:.45;cursor:not-allowed}
#wizardButtons button:not(.primary):hover{background:#f3f7ff}
#wizardOutput{
  display:none;margin-top:.6rem;padding:1rem 1rem 1.1rem;
  background:#fff;border:1px solid var(--border-mid);border-radius:20px;
  font-size:.72rem;line-height:1.45;max-height:320px;overflow:auto;
  box-shadow:var(--shadow-small);
}
/* Gauges */
.gauge-wrap{display:flex;gap:1.25rem;flex-wrap:wrap}
.score-gauge{width:142px;height:142px;position:relative}
.score-gauge svg{transform:rotate(-90deg)}
.score-gauge circle{fill:none;stroke-width:14;stroke-linecap:round}
.gauge-bg{stroke:#d1ddee}
.gauge-val{stroke:url(#gradScore);stroke-dasharray:520;stroke-dashoffset:520;transition:stroke-dashoffset 1.1s cubic-bezier(.4,.8,.3,1)}
.gauge-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.gauge-center .big{font-size:1.65rem;font-weight:700;letter-spacing:.5px;color:#132238}
.gauge-center span{font-size:.56rem;letter-spacing:.1em;color:var(--muted);margin-top:2px}
/* Metrics */
.metric-row{display:flex;flex-wrap:wrap;gap:.7rem}
.metric{
  flex:1 1 140px;min-width:136px;display:flex;flex-direction:column;gap:.4rem;
  background:#ffffff; border:1px solid var(--border-soft);
  border-radius:18px;padding:.7rem .8rem .75rem;box-shadow:var(--shadow-small)
}
.metric strong{font-size:1.05rem;font-weight:700;color:#0f1e33}
.metric span{font-size:.52rem;font-weight:600;letter-spacing:.12em;color:var(--muted);text-transform:uppercase}
.progress-bar{height:8px;background:var(--progress-bg);border-radius:6px;overflow:hidden;position:relative}
.progress-bar span{position:absolute;left:0;top:0;height:100%;width:0;background:var(--grad-bar);transition:width .9s;border-radius:inherit}
/* Pills */
.pills{display:flex;flex-wrap:wrap;gap:.45rem}
.pill{
  background:#ffffff;color:#1c2c47;
  padding:.45rem .65rem;font-size:.55rem;font-weight:600;border:1px solid var(--border-soft);
  border-radius:999px;letter-spacing:.05em;box-shadow:0 4px 10px -4px rgba(0,0,0,.15)
}
/* Planet */
.planet-card{display:flex;flex-direction:column;gap:.9rem;align-items:center;text-align:center}
#planetCanvas{width:205px;height:205px}
.ring-progress-bar{width:100%;height:8px;background:#dee7f3;border-radius:6px;overflow:hidden;position:relative}
.ring-progress-bar span{position:absolute;left:0;top:0;height:100%;width:0;background:var(--grad-bar);transition:width .9s}
.ring-info{font-size:.6rem;color:var(--muted);line-height:1.35}
.badges{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.15rem;justify:center}
.badge{
  display:inline-flex;align-items:center;gap:.3rem;padding:.45rem .6rem;background:#fff;
  border:1px solid var(--border-soft);border-radius:14px;font-size:.53rem;font-weight:600;
  letter-spacing:.08em;cursor:help;color:#20314b;box-shadow:0 4px 12px -6px rgba(0,0,0,.18)
}
.badge.good{background:#e3f8ec;border-color:#b6eccb;color:#155f35}
.badge.warn{background:#fff4d8;border-color:#ffe3a1;color:#8a5c00}
.badge.perf{background:#ffe1e8;border-color:#ffc2d0;color:#892642}
/* Focus / Skills */
.focus-pills{display:flex;flex-wrap:wrap;gap:.55rem}
.focus-pill{
  background:#fff;border:1px solid var(--border-soft);
  padding:.5rem .7rem;border-radius:14px;font-size:.55rem;font-weight:600;letter-spacing:.08em;color:#1c2d47;box-shadow:0 4px 10px -4px rgba(0,0,0,.12)
}
.focus-pill.low{background:#ffe2e2;border-color:#ffb4b4;color:#7a1111}
.focus-pill.mid{background:#fff2d8;border-color:#ffd687;color:#7a5408}
.focus-pill.good{background:#e3f8ec;border-color:#b6eccb;color:#155f35}
.skill-row{display:flex;flex-direction:column;gap:.3rem;margin:0 0 .45rem}
.skill-label{display:flex;justify-content:space-between;font-size:.55rem;font-weight:600;color:#132238;letter-spacing:.08em}
.skill-bar{height:7px;background:#dfe7f2;border-radius:5px;overflow:hidden;position:relative}
.skill-bar span{position:absolute;left:0;top:0;height:100%;background:var(--grad-bar);width:0;transition:width 1s}
/* Attempts Table */
.table-wrap{overflow:auto;max-height:350px;border:1px solid var(--border-soft);border-radius:18px;background:#ffffffb8}
table{border-collapse:collapse;width:100%;font-size:.6rem;min-width:640px}
th,td{padding:.55rem .65rem;text-align:left;border-bottom:1px solid #e2e9f2}
thead th{background:#f3f7fc;font-weight:600;letter-spacing:.08em;font-size:.53rem;color:#314861;text-transform:uppercase}
tbody tr:hover{background:#f5f9ff}
tbody tr:last-child td{border-bottom:none}
.filter-row{display:flex;gap:.55rem;flex-wrap:wrap;margin-bottom:.4rem}
select,button.small-btn{
  font:inherit;font-size:.55rem;font-weight:600;letter-spacing:.05em;
  padding:.5rem .75rem;border-radius:12px;border:1px solid var(--border-mid);
  background:#ffffffcc;color:#1d2d42;cursor:pointer;transition:background .25s,box-shadow .25s;text-transform:uppercase
}
button.small-btn:hover,select:hover{background:#fff;box-shadow:0 4px 10px -4px rgba(33,86,255,.25)}
/* Study Plan */
#studyPlanEditor{
  min-height:190px;background:#ffffff;border:1px solid var(--border-mid);
  border-radius:20px;padding:.9rem .95rem;font-size:.78rem;line-height:1.5;outline:none;overflow:auto;box-shadow:var(--shadow-small)
}
#studyPlanEditor:empty:before{content:"Create or refine your weekly plan…";color:#98a7b8}
.plan-actions{display:flex;flex-wrap:wrap;gap:.5rem}
.plan-actions button{
  background:#ffffff;border:1px solid var(--border-mid);color:#15315d;
  padding:.55rem .85rem;font-size:.55rem;font-weight:600;border-radius:14px;cursor:pointer;
  letter-spacing:.06em;transition:background .25s,box-shadow .25s;text-transform:uppercase
}
.plan-actions button:hover{background:#f3f7ff;box-shadow:0 4px 10px -5px rgba(21,49,93,.25)}
.plan-actions button.danger{color:#a0182c;border-color:#f5a3b0;background:#ffe9ed}
.plan-actions button.danger:hover{background:#ffd6de}
/* Footer */
footer{text-align:center;padding:3rem 1rem 3.5rem;font-size:.7rem;color:var(--muted)}
/* Responsive Tweaks */
@media(max-width:560px){
  .gauge-wrap{justify-content:center}
  .score-gauge{width:130px;height:130px}
  .wizard-inline > div{min-width:46%}
}
/* Anim */
.fade-in{animation:fadeIn .6s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
<header id="topbar">
  <div class="brand">
    <img src="images/Logo.png" alt="SATurn Bound logo">
    <span>SATurn&nbsp;Bound</span>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="practice-tests.html">Tests</a>
    <a href="dashboard.html" class="active">Dashboard</a>
    <a href="aboutus.html">Our Team</a>
    <a href="login.html">Log In</a>
  </nav>
</header>

<main>
  <div class="grid">

    <!-- Plan Wizard -->
    <div class="panel fade-in" id="planWizardPanel">
      <h3>Plan Wizard <span class="sub">Score → Target</span></h3>
      <form id="planWizardForm">
        <div class="wizard-inline">
          <div>
            <label class="small-label" for="currMath">Current Math</label>
            <input type="number" id="currMath" min="200" max="800" step="10" placeholder="e.g. 570">
          </div>
            <div>
              <label class="small-label" for="targetMath">Target Math</label>
              <input type="number" id="targetMath" min="200" max="800" step="10" placeholder="e.g. 700">
            </div>
          <div>
            <label class="small-label" for="currEng">Current English</label>
            <input type="number" id="currEng" min="200" max="800" step="10" placeholder="e.g. 540">
          </div>
          <div>
            <label class="small-label" for="targetEng">Target English</label>
            <input type="number" id="targetEng" min="200" max="800" step="10" placeholder="e.g. 680">
          </div>
          <div>
            <label class="small-label" for="weeksOut">Weeks Until Test</label>
            <input type="number" id="weeksOut" min="1" max="52" placeholder="e.g. 10">
          </div>
          <div>
            <label class="small-label" for="hrsPerWeek">Hours / Week (Total)</label>
            <input type="number" id="hrsPerWeek" min="1" max="60" placeholder="e.g. 8">
          </div>
        </div>
        <div id="wizardButtons">
          <button type="submit" class="primary">Generate Plan</button>
          <button type="button" id="wizardInsertBtn" disabled>Insert to Editor</button>
          <button type="button" id="wizardResetBtn">Reset</button>
        </div>
      </form>
      <div id="wizardOutput"></div>
      <div style="font-size:.52rem;color:var(--muted);margin-top:.25rem">
        Based on gap size & weeks. Re-run after each full test.
      </div>
    </div>

    <!-- Planet -->
    <div class="panel fade-in" id="planetPanel">
      <h3>Planet Progress <span class="sub">Rings & Badges</span></h3>
      <div class="planet-card">
        <svg id="planetCanvas" viewBox="0 0 260 260" role="img" aria-label="Saturn progression">
          <defs>
            <radialGradient id="planetGrad" cx="50%" cy="38%" r="60%">
              <stop offset="0%" stop-color="#fff6d9"/>
              <stop offset="55%" stop-color="#f5d69e"/>
              <stop offset="100%" stop-color="#e8b75a"/>
            </radialGradient>
            <linearGradient id="ringGrad" x1="0%" y1="50%" x2="100%" y2="50%">
              <stop offset="0%" stop-color="#2156ff"/>
              <stop offset="100%" stop-color="#f27891"/>
            </linearGradient>
            <linearGradient id="gradScore" x1="0%" y1="50%" x2="100%" y2="50%">
              <stop offset="0%" stop-color="#2156ff"/>
              <stop offset="100%" stop-color="#f27891"/>
            </linearGradient>
          </defs>
          <circle cx="130" cy="130" r="63" fill="url(#planetGrad)" stroke="#d8a849" stroke-width="2"></circle>
          <g id="ringsGroup"></g>
        </svg>
        <div class="ring-progress-bar"><span id="ringProgress"></span></div>
        <div class="ring-info" id="ringInfo">Loading ring data…</div>
        <div class="badges" id="badgesHolder"></div>
      </div>
    </div>

    <!-- Scores -->
    <div class="panel fade-in" id="scoresPanel">
      <h3>Section Scores <span class="sub">Math & English</span></h3>
      <div class="gauge-wrap">
        <div class="score-gauge">
          <svg width="142" height="142">
            <circle class="gauge-bg" cx="71" cy="71" r="60"></circle>
            <circle class="gauge-val" id="mathGauge" cx="71" cy="71" r="60"></circle>
          </svg>
          <div class="gauge-center">
            <div class="big" id="mathScore">--</div>
            <span>MATH / 800</span>
          </div>
        </div>
        <div class="score-gauge">
          <svg width="142" height="142">
            <circle class="gauge-bg" cx="71" cy="71" r="60"></circle>
            <circle class="gauge-val" id="engGauge" cx="71" cy="71" r="60"></circle>
          </svg>
          <div class="gauge-center">
            <div class="big" id="engScore">--</div>
            <span>ENG / 800</span>
          </div>
        </div>
      </div>
      <div class="metric-row">
        <div class="metric">
          <strong id="overallAcc">--%</strong>
          <span>Weighted Accuracy</span>
          <div class="progress-bar"><span id="overallAccBar"></span></div>
        </div>
        <div class="metric">
          <strong id="attemptTotal">0</strong>
          <span>Total Attempts</span>
        </div>
        <div class="metric">
          <strong id="deltaMath">--</strong>
          <span>Math Δ (Last)</span>
        </div>
        <div class="metric">
          <strong id="deltaEng">--</strong>
          <span>Eng Δ (Last)</span>
        </div>
      </div>
      <div class="pills" id="diffPills"></div>
    </div>

    <!-- Focus -->
    <div class="panel fade-in" id="focusPanel">
      <h3>Today's Focus <span class="sub">Weakest Skills</span></h3>
      <div class="focus-pills" id="focusSkills">Not enough data yet.</div>
      <button class="small-btn" id="refreshFocus">Recalculate</button>
      <p style="font-size:.55rem;color:var(--muted);margin:2px 0 0;">Top 3 weakest skills (weighted). Boost these to advance rings faster.</p>
    </div>

    <!-- Skills -->
    <div class="panel fade-in" id="skillsPanel">
      <h3>Skill Accuracy <span class="sub">By Tag</span></h3>
      <div id="skillBars">Tag questions with skill metadata to populate.</div>
    </div>

    <!-- Attempts -->
    <div class="panel fade-in" id="attemptsPanel">
      <h3>Recent Attempts <span class="sub">History</span></h3>
      <div class="filter-row">
        <select id="sectionFilter">
          <option value="all">All Sections</option>
          <option value="math">Math</option>
          <option value="english">English</option>
        </select>
        <select id="limitFilter">
          <option value="6">Last 6</option>
          <option value="10">Last 10</option>
          <option value="25">Last 25</option>
          <option value="all">All</option>
        </select>
        <button class="small-btn" id="clearLocal">Clear Local Attempts</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Date</th><th>Section</th><th>Test</th><th>Raw</th><th>Weighted%</th><th>Est Score</th><th>Missed</th></tr>
          </thead>
          <tbody id="attemptsBody">
            <tr><td colspan="7" style="text-align:center;padding:1rem;color:var(--muted)">No attempts yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Study Plan -->
    <div class="panel fade-in" id="planPanel">
      <h3>Personal Study Plan <span class="sub">Editable</span></h3>
      <div id="studyPlanEditor" contenteditable="true"></div>
      <div class="plan-actions">
        <button id="btnSavePlan">Save</button>
        <button id="btnTemplate">Template</button>
        <button id="btnPrintPlan">Print</button>
        <button id="btnClearPlan" class="danger">Clear</button>
      </div>
      <div style="font-size:.52rem;color:var(--muted);">Autosaves every 5s • Last saved: <span id="planSavedTime">Never</span></div>
    </div>

  </div>
</main>

<footer>&copy; SATurn Bound 2025. All rights reserved.</footer>

<script type="module">
/* Header shadow */
const topbar=document.getElementById('topbar');
window.addEventListener('scroll',()=>topbar.classList.toggle('scrolled',window.scrollY>12));

/* ===== CONFIG / CONSTANTS ===== */
const WEIGHTS={easy:1.0,medium:1.4,hard:1.8};
const PENALIZE_MISSES=false;
const MAX_SCORE=800;
const RING_THRESHOLDS=[10,25,40,55,70,85,95];
/* Add more localStorage result keys here */
const ATTEMPT_KEYS_MATH=['practiceTest2Results'];
const ATTEMPT_KEYS_ENGLISH=['readingTest1Results'];

/* ===== LOAD ATTEMPTS ===== */
function loadAttempts(keys, section){
  const arr=[];
  keys.forEach(k=>{
    const raw=localStorage.getItem(k);
    if(!raw)return;
    try{
      const d=JSON.parse(raw);
      arr.push({
        key:k,
        date:new Date(d.timestamp||Date.now()),
        score:d.score,
        total:d.totalQuestions,
        answers:d.answers||{},
        meta:d.questionMeta||{},
        section,
        testName:k.replace(/Results$/,'')
      });
    }catch(e){}
  });
  return arr;
}
let mathAttempts=loadAttempts(ATTEMPT_KEYS_MATH,'math');
let engAttempts =loadAttempts(ATTEMPT_KEYS_ENGLISH,'english');
let allAttempts=[...mathAttempts,...engAttempts].sort((a,b)=>b.date-a.date);

/* ===== WEIGHTED STATS ===== */
function perAttemptWeighted(a){
  let totalW=0,correctW=0,incorrectW=0;
  Object.entries(a.answers).forEach(([qid,uAns])=>{
    const meta=a.meta[qid]||{};
    const diff=(meta.difficulty||'medium').toLowerCase();
    const w=WEIGHTS[diff]||WEIGHTS.medium;
    totalW+=w;
    const correct=meta.correct||uAns;
    if(uAns===correct) correctW+=w; else incorrectW+=w;
  });
  if(!totalW) return {ratio:0,est:0,totalW:0,correctW:0};
  let ratio=correctW/totalW;
  if(PENALIZE_MISSES) ratio=Math.max(0,(correctW-0.05*incorrectW)/totalW);
  return {ratio,est:Math.round(MAX_SCORE*ratio),totalW,correctW};
}
function aggregateSection(section){
  const list=section==='math'?mathAttempts:engAttempts;
  if(!list.length) return {ratio:0,est:0,delta:null};
  const avg=list.reduce((s,a)=>s+perAttemptWeighted(a).ratio,0)/list.length;
  const latest=perAttemptWeighted(list[0]);
  const prev=list[1]?perAttemptWeighted(list[1]):null;
  return {ratio:avg,est:Math.round(MAX_SCORE*avg),delta:prev?latest.est-prev.est:null};
}
function overallWeighted(){
  const arr=[...mathAttempts,...engAttempts];
  if(!arr.length) return 0;
  let totalW=0,correctW=0;
  arr.forEach(a=>{
    const w=perAttemptWeighted(a);
    totalW+=w.totalW;correctW+=w.correctW;
  });
  return totalW?correctW/totalW:0;
}
const mathAgg=aggregateSection('math');
const engAgg=aggregateSection('english');
const overallAcc=overallWeighted();

/* ===== GAUGES ===== */
const circumference=2*Math.PI*60;
function setGauge(el,ratio){
  el.style.strokeDasharray=circumference;
  el.style.strokeDashoffset=circumference*(1-ratio);
}
setGauge(document.getElementById('mathGauge'),mathAgg.ratio);
setGauge(document.getElementById('engGauge'),engAgg.ratio);
document.getElementById('mathScore').textContent=mathAgg.est||'--';
document.getElementById('engScore').textContent=engAgg.est||'--';
document.getElementById('overallAcc').textContent=overallAcc? (overallAcc*100).toFixed(1)+'%' : '--%';
document.getElementById('overallAccBar').style.width=(overallAcc*100)+'%';
document.getElementById('attemptTotal').textContent=allAttempts.length;
const deltaMathEl=document.getElementById('deltaMath');
deltaMathEl.textContent=mathAgg.delta===null?'--':(mathAgg.delta>0? '+'+mathAgg.delta:mathAgg.delta);
deltaMathEl.style.color=mathAgg.delta>0?'#155f35':(mathAgg.delta<0?'#a0182c':'#0d1117');
const deltaEngEl=document.getElementById('deltaEng');
deltaEngEl.textContent=engAgg.delta===null?'--':(engAgg.delta>0? '+'+engAgg.delta:engAgg.delta);
deltaEngEl.style.color=engAgg.delta>0?'#155f35':(engAgg.delta<0?'#a0182c':'#0d1117');

/* ===== Difficulty Pills ===== */
function difficultyBreakdown(){
  const totals={},corrects={};
  allAttempts.forEach(a=>{
    Object.entries(a.answers).forEach(([qid,uAns])=>{
      const meta=a.meta[qid]||{};
      const diff=(meta.difficulty||'medium').toLowerCase();
      const w=WEIGHTS[diff]||WEIGHTS.medium;
      totals[diff]=(totals[diff]||0)+w;
      const correct=meta.correct||uAns;
      if(uAns===correct) corrects[diff]=(corrects[diff]||0)+w;
    });
  });
  const holder=document.getElementById('diffPills');
  holder.innerHTML='';
  Object.keys(WEIGHTS).forEach(diff=>{
    if(!totals[diff]) return;
    const pct=((corrects[diff]||0)/totals[diff]*100).toFixed(0);
    const div=document.createElement('div');
    div.className='pill';
    div.textContent=diff.charAt(0).toUpperCase()+diff.slice(1)+': '+pct+'%';
    holder.appendChild(div);
  });
}
difficultyBreakdown();

/* ===== Skills Bars ===== */
function buildSkills(){
  const totals={},corrects={};
  allAttempts.forEach(a=>{
    Object.entries(a.answers).forEach(([qid,uAns])=>{
      const meta=a.meta[qid]||{};
      const skill=meta.skill||'Untagged';
      const diff=(meta.difficulty||'medium').toLowerCase();
      const w=WEIGHTS[diff]||WEIGHTS.medium;
      totals[skill]=(totals[skill]||0)+w;
      const correct=meta.correct||uAns;
      if(uAns===correct) corrects[skill]=(corrects[skill]||0)+w;
    });
  });
  const container=document.getElementById('skillBars');
  container.innerHTML='';
  const skills=Object.keys(totals);
  if(!skills.length){container.textContent='Tag questions with skill metadata to view accuracy breakdown.';return;}
  skills.sort().forEach(sk=>{
    const pct=(corrects[sk]||0)/totals[sk];
    const row=document.createElement('div');
    row.className='skill-row';
    row.innerHTML=`
      <div class="skill-label"><span>${sk}</span><span>${(pct*100).toFixed(0)}%</span></div>
      <div class="skill-bar"><span style="width:${(pct*100).toFixed(1)}%"></span></div>
    `;
    container.appendChild(row);
  });
}
buildSkills();

/* ===== Focus Skills ===== */
function buildFocus(){
  const totals={},corrects={};
  allAttempts.forEach(a=>{
    Object.entries(a.answers).forEach(([qid,uAns])=>{
      const meta=a.meta[qid]||{};
      const skill=meta.skill||'Untagged';
      const diff=(meta.difficulty||'medium').toLowerCase();
      const w=WEIGHTS[diff]||WEIGHTS.medium;
      totals[skill]=(totals[skill]||0)+w;
      const correct=meta.correct||uAns;
      if(uAns===correct) corrects[skill]=(corrects[skill]||0)+w;
    });
  });
  const holder=document.getElementById('focusSkills');
  holder.innerHTML='';
  const list=Object.keys(totals).map(sk=>{
    const pct=(corrects[sk]||0)/totals[sk];
    return {skill:sk,pct};
  }).sort((a,b)=>a.pct-b.pct);
  if(!list.length){holder.textContent='Not enough data yet.';return;}
  list.slice(0,3).forEach(item=>{
    const pill=document.createElement('div');
    pill.className='focus-pill '+(item.pct<.5?'low':item.pct<.75?'mid':'good');
    pill.textContent=item.skill+' • '+(item.pct*100).toFixed(0)+'%';
    holder.appendChild(pill);
  });
}
buildFocus();
document.getElementById('refreshFocus').onclick=()=>{
  buildFocus(); buildSkills(); difficultyBreakdown();
};

/* ===== Attempts Table ===== */
function renderAttempts(){
  const tbody=document.getElementById('attemptsBody');
  const sectionVal=document.getElementById('sectionFilter').value;
  const limitVal=document.getElementById('limitFilter').value;
  tbody.innerHTML='';
  let filtered=[...allAttempts];
  if(sectionVal!=='all') filtered=filtered.filter(a=>a.section===sectionVal);
  if(limitVal!=='all') filtered=filtered.slice(0,+limitVal);
  if(!filtered.length){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:1rem;color:#536274">No attempts</td></tr>';
    return;
  }
  filtered.forEach(a=>{
    const w=perAttemptWeighted(a);
    const missed=a.total - a.score;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${a.date.toLocaleDateString()}</td>
      <td style="text-transform:capitalize">${a.section}</td>
      <td>${a.testName}</td>
      <td>${a.score}/${a.total}</td>
      <td>${(w.ratio*100).toFixed(1)}%</td>
      <td>${w.est}</td>
      <td>${missed}</td>
    `;
    tbody.appendChild(tr);
  });
}
renderAttempts();
document.getElementById('sectionFilter').onchange=renderAttempts;
document.getElementById('limitFilter').onchange=renderAttempts;
document.getElementById('clearLocal').onclick=()=>{
  if(!confirm('Clear local attempt data?')) return;
  [...ATTEMPT_KEYS_MATH,...ATTEMPT_KEYS_ENGLISH].forEach(k=>localStorage.removeItem(k));
  mathAttempts=[];engAttempts=[];allAttempts=[];
  renderAttempts();buildSkills();buildFocus();difficultyBreakdown();
  document.getElementById('mathScore').textContent='--';
  document.getElementById('engScore').textContent='--';
  updatePlanet();renderBadges();
  document.getElementById('overallAcc').textContent='--%';
  document.getElementById('overallAccBar').style.width='0%';
  document.getElementById('attemptTotal').textContent='0';
};

/* ===== Planet / Rings ===== */
function computeRingStatus(){
  const combinedAcc=overallWeighted();
  const attempts=allAttempts.length;
  const P=combinedAcc*100;
  const V=Math.min(attempts/12*100,100);
  const S=0.75*P+0.25*V;
  let rings=0;
  for(let i=0;i<RING_THRESHOLDS.length;i++){
    if(S>=RING_THRESHOLDS[i]) rings=i+1; else break;
  }
  const next=RING_THRESHOLDS[rings]||100;
  const prev=rings?RING_THRESHOLDS[rings-1]:0;
  const segment=(S-prev)/(next-prev||1);
  return {S,rings,nextThreshold:next,prevThreshold:prev,progressSegment:segment,P,V,attempts};
}
function drawRings(rs){
  const group=document.getElementById('ringsGroup');
  group.innerHTML='';
  for(let i=1;i<=rs.rings;i++){
    const scale=0.9 + i*0.06;
    const ring=document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    ring.setAttribute('cx','130');
    ring.setAttribute('cy','130');
    ring.setAttribute('rx',String(70*scale));
    ring.setAttribute('ry',String(24*scale));
    ring.setAttribute('fill','none');
    ring.setAttribute('stroke','url(#ringGrad)');
    ring.setAttribute('stroke-width','2.1');
    ring.setAttribute('opacity',(0.35 + i*0.08).toFixed(2));
    group.appendChild(ring);
  }
}
function updatePlanet(){
  const rs=computeRingStatus();
  drawRings(rs);
  document.getElementById('ringProgress').style.width=(rs.progressSegment*100)+'%';
  document.getElementById('ringInfo').innerHTML=`
    Rings: <strong>${rs.rings}</strong> / 7<br>
    Index S: ${rs.S.toFixed(1)} / 100<br>
    ${rs.rings===7?'Maxed rings!':`Next Ring at ${rs.nextThreshold} • Segment ${(rs.progressSegment*100).toFixed(0)}%`}<br>
    <span style="opacity:.75;">Perf ${rs.P.toFixed(0)} | Volume ${rs.V.toFixed(0)} | Attempts ${rs.attempts}</span>
  `;
}
updatePlanet();

/* ===== Badges ===== */
function evaluateBadges(){
  const badges=[];
  const combinedAcc=overallWeighted();
  const last5=allAttempts.slice(0,5).map(a=>perAttemptWeighted(a).ratio*100);
  const stdDev= last5.length<3? 999 : (()=>{
    const m=last5.reduce((s,x)=>s+x,0)/last5.length;
    const v=last5.reduce((s,x)=>s+(x-m)**2,0)/last5.length;
    return Math.sqrt(v);
  })();
  const streak3=allAttempts.slice(0,3).every(a=>perAttemptWeighted(a).ratio>=0.65);
  if(allAttempts.length>=1) badges.push({id:'first_attempt',label:'First Attempt',cls:'good',tip:'Completed your first practice set.'});
  if(mathAgg.est>=600) badges.push({id:'math_600',label:'Math 600+',cls:'good',tip:'Estimated Math ≥ 600.'});
  if(engAgg.est>=600) badges.push({id:'eng_600',label:'Eng 600+',cls:'good',tip:'Estimated English ≥ 600.'});
  if(mathAgg.est>=700 && engAgg.est>=700) badges.push({id:'dual_700',label:'Dual 700+',cls:'good',tip:'700+ in both sections.'});
  if(mathAgg.est===800 || engAgg.est===800) badges.push({id:'perfect_800_any',label:'Perfect 800',cls:'perf',tip:'Perfect section estimate.'});
  if(streak3) badges.push({id:'streak_3',label:'3‑Streak',cls:'warn',tip:'Three consecutive ≥65% attempts.'});
  if(combinedAcc>=0.80) badges.push({id:'accuracy_80',label:'80% Acc',cls:'good',tip:'Overall weighted accuracy ≥80%.'});
  if(stdDev<=5) badges.push({id:'consistency_low_var',label:'Consistent',cls:'warn',tip:'Low variance across last 5 attempts.'});
  return badges;
}
function renderBadges(){
  const holder=document.getElementById('badgesHolder');
  holder.innerHTML='';
  const list=evaluateBadges();
  if(!list.length){
    holder.innerHTML='<div style="font-size:.5rem;opacity:.6;">Earn badges by practicing!</div>';
    return;
  }
  list.forEach(b=>{
    const div=document.createElement('div');
    div.className='badge '+b.cls;
    div.textContent=b.label;
    div.title=b.tip;
    holder.appendChild(div);
  });
}
renderBadges();

/* ===== Study Plan Persistence ===== */
const PLAN_KEY='dashboard_study_plan_v2';
const PLAN_TIME_KEY='dashboard_study_plan_saved_at';
const planEditor=document.getElementById('studyPlanEditor');
const planTime=document.getElementById('planSavedTime');
let planDirty=false;
function loadPlan(){
  const saved=localStorage.getItem(PLAN_KEY);
  if(saved) planEditor.innerHTML=saved;
  const t=localStorage.getItem(PLAN_TIME_KEY);
  if(t) planTime.textContent=new Date(+t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}
loadPlan();
planEditor.addEventListener('input',()=>{planDirty=true;});
setInterval(()=>{ if(planDirty) savePlan(); },5000);
function savePlan(){
  localStorage.setItem(PLAN_KEY,planEditor.innerHTML);
  const now=Date.now();
  localStorage.setItem(PLAN_TIME_KEY,now);
  planTime.textContent=new Date(now).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  planDirty=false;
}
document.getElementById('btnSavePlan').onclick=savePlan;
document.getElementById('btnPrintPlan').onclick=()=>{
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>Study Plan</title>
  <style>body{font-family:Inter,Arial,sans-serif;padding:24px;line-height:1.55;font-size:15px;color:#111;background:#f5f8fc}h1{margin-top:0}</style></head>
  <body><h1>Study Plan</h1>${planEditor.innerHTML}</body></html>`);
  w.document.close();w.focus();w.print();
};
document.getElementById('btnTemplate').onclick=()=>{
  planEditor.innerHTML+=`
  <h4 style="margin-top:1rem;">Weekly Cycle</h4>
  <ul>
    <li><strong>Mon:</strong> Weak Skill 1 (review + 10 targeted).</li>
    <li><strong>Tue:</strong> Weak Skill 2 + 5 mixed medium.</li>
    <li><strong>Wed:</strong> Timed mini-set (20Q) pacing.</li>
    <li><strong>Thu:</strong> Reading inference / data sets.</li>
    <li><strong>Fri:</strong> Hard accuracy drill + error log.</li>
    <li><strong>Sat:</strong> Full practice test.</li>
    <li><strong>Sun:</strong> Light review & retest misses.</li>
  </ul>
  <h4>Targets (Next 2 Weeks)</h4>
  <ul>
    <li>Raise weakest 3 skills to ≥65% weighted.</li>
    <li>Math est +40, English est +30.</li>
    <li>Maintain ≥55% accuracy on hard items.</li>
  </ul>`;
  planDirty=true;
};
document.getElementById('btnClearPlan').onclick=()=>{
  if(confirm('Clear study plan content?')){
    planEditor.innerHTML='';
    savePlan();
  }
};

/* ===== PLAN WIZARD ===== */
const wizardForm=document.getElementById('planWizardForm');
const wizardOut=document.getElementById('wizardOutput');
const insertBtn=document.getElementById('wizardInsertBtn');
const resetBtn=document.getElementById('wizardResetBtn');

function phaseDistribution(gap, weeks){
  // Base proportions adjust by gap magnitude
  let ramp=0.25,intens=0.35,sharp=0.3,taper=0.1;
  if(gap<=120){ramp=0.30;intens=0.32;sharp=0.28;taper=0.10;}
  else if(gap>=260){ramp=0.22;intens=0.38;sharp=0.30;taper=0.10;}
  let r=Math.max(1,Math.round(weeks*ramp));
  let i=Math.max(1,Math.round(weeks*intens));
  let s=Math.max(1,Math.round(weeks*sharp));
  let used=r+i+s;
  let t=Math.max(1,weeks-used);
  return {r,i,s,t};
}
function phaseHours(total,gap){
  // Slight scaling if gap is large
  const boost = gap>240?1.15: gap>160?1.05:1;
  return {
    ramp:Math.round(total*0.85),
    intens:Math.round(total*1.05*boost),
    sharp:Math.round(total*boost),
    taper:Math.max(3,Math.round(total*0.55))
  };
}
function bulletListMath(phase){
  switch(phase){
    case 'ramp': return [
      "Diagnose algebra & functions weaknesses",
      "Re-learn core formulas (ratios, linear models)",
      "Daily light QOD habit (math)",
      "Error log tagging by concept"
    ];
    case 'intens': return [
      "Timed mini-sets (20Q) 2× weekly",
      "Target medium weaknesses (nonlinear, systems)",
      "Introduce harder data analysis sets",
      "Weekly full math section"
    ];
    case 'sharp': return [
      "Hard item accuracy push (goal 55–60%)",
      "Mixed sets under strict pacing",
      "Refine guess / elimination strategies",
      "Error pattern flash review"
    ];
    default: return [
      "Light mixed review (15–20Q)",
      "Flashcards: formulas & error patterns",
      "1 early-week full section only",
      "Rest & sleep prioritization"
    ];
  }
}
function bulletListEng(phase){
  switch(phase){
    case 'ramp': return [
      "Core grammar refresh (boundaries, transitions)",
      "Main idea & inference drills",
      "Daily vocab-in-context mini review",
      "Start concise error log"
    ];
    case 'intens': return [
      "Timed reading passages (focus pacing checkpoints)",
      "Synthesis / evidence pair questions",
      "Increase complex transitions practice",
      "Weekly full English section"
    ];
    case 'sharp': return [
      "Dual passage comparisons",
      "Hard inference & function questions",
      "Rhetorical synthesis refinement",
      "Target fastest improvement gaps"
    ];
    default: return [
      "Light passage + grammar set",
      "Refine top recurring misses",
      "Active rest + lexical review",
      "Confidence calibration"
    ];
  }
}
function weeklyStructure(){
  return `Mon: Weak Skill Drill (10–15Q) + Review
Tue: Mini-set (20Q) + Error Log
Wed: Math/Eng Alt Timed Section
Thu: Mixed Medium→Hard Set
Fri: Hard Accuracy Drill + Review
Sat: Full Practice (alternating sections)
Sun: Light Retest + Flashcards`;
}
function safe(v){return isNaN(v)?0:v;}

wizardForm.addEventListener('submit', e=>{
  e.preventDefault();
  const cM=safe(+document.getElementById('currMath').value);
  const tM=safe(+document.getElementById('targetMath').value);
  const cE=safe(+document.getElementById('currEng').value);
  const tE=safe(+document.getElementById('targetEng').value);
  const weeks=safe(+document.getElementById('weeksOut').value);
  const hrs=safe(+document.getElementById('hrsPerWeek').value);

  wizardOut.style.display='block';
  if(!cM||!tM||!cE||!tE||!weeks||!hrs){
    wizardOut.innerHTML='<em>Please fill all fields.</em>';
    insertBtn.disabled=true; return;
  }
  if(tM<=cM || tE<=cE){
    wizardOut.innerHTML='<em>Targets must exceed current scores.</em>';
    insertBtn.disabled=true; return;
  }
  if([cM,tM,cE,tE].some(v=>v<200||v>800)){
    wizardOut.innerHTML='<em>Scores must be between 200 and 800.</em>';
    insertBtn.disabled=true; return;
  }

  const gapTotal=(tM-cM)+(tE-cE);
  const {r,i,s,t}=phaseDistribution(gapTotal,weeks);
  const phaseH=phaseHours(hrs,gapTotal);

  const gainPerWeek=(gapTotal/weeks).toFixed(1);
  const mathShare=(tM-cM)/gapTotal;
  const engShare=(tE-cE)/gapTotal;
  const mathHrsBase=Math.round(hrs*mathShare);
  const engHrsBase=Math.max(1,hrs-mathHrsBase);

  function phaseBlock(label,weeksCount,phaseKey){
    const mathBul=bulletListMath(phaseKey);
    const engBul=bulletListEng(phaseKey);
    return `
    <h4><span class="phaseTag">${phaseKey}</span>${label} (${weeksCount} wk${weeksCount>1?'s':''})</h4>
    <strong style="font-size:.63rem;letter-spacing:.08em;">Math Focus:</strong>
    <ul>${mathBul.map(b=>`<li>${b}</li>`).join('')}</ul>
    <strong style="font-size:.63rem;letter-spacing:.08em;">English Focus:</strong>
    <ul>${engBul.map(b=>`<li>${b}</li>`).join('')}</ul>
    <p style="font-size:.62rem;margin:.2rem 0 0;"><strong>Suggested Weekly Hours:</strong> ${phaseH[phaseKey]} (≈ ${(phaseH[phaseKey]/7).toFixed(1)}/day)</p>`;
  }

  const html=`
  <div style="font-weight:600;font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;color:${getComputedStyle(document.documentElement).getPropertyValue('--brand-dark')};margin-bottom:.4rem">
    AUTO-GENERATED PLAN
  </div>
  <p style="margin:0 0 .6rem;font-size:.7rem;line-height:1.4;">
    <strong>Current:</strong> M ${cM} / E ${cE} •
    <strong>Targets:</strong> M ${tM} / E ${tE} •
    <strong>Gaps:</strong> +${tM-cM} (Math), +${tE-cE} (Eng) = +${gapTotal} total<br>
    <strong>Weeks:</strong> ${weeks} • <strong>Avg Gain Needed:</strong> ~${gainPerWeek}/week •
    <strong>Hours/Week:</strong> ${hrs} (≈ Math ${mathHrsBase}, Eng ${engHrsBase})
  </p>

  ${phaseBlock('Phase 1 – Ramp',r,'ramp')}
  ${phaseBlock('Phase 2 – Intensify',i,'intens')}
  ${phaseBlock('Phase 3 – Sharpen',s,'sharp')}
  ${phaseBlock('Phase 4 – Taper',t,'taper')}

  <h4>Weekly Structure Template</h4>
  <pre>${weeklyStructure()}</pre>
  <p style="margin-top:.6rem;font-size:.6rem;color:var(--muted)">
    Recompute after every two full practice tests or significant pacing change.
  </p>`;

  wizardOut.innerHTML=html;
  insertBtn.disabled=false;
  wizardOut.scrollIntoView({behavior:'smooth',block:'center'});
});

insertBtn.addEventListener('click',()=>{
  if(wizardOut.style.display!=='block' || !wizardOut.innerHTML.trim()) return;
  const block=document.createElement('div');
  block.innerHTML=wizardOut.innerHTML;
  planEditor.appendChild(block);
  planEditor.scrollIntoView({behavior:'smooth',block:'center'});
  planDirty=true;
});
resetBtn.addEventListener('click',()=>{
  wizardForm.reset();
  wizardOut.style.display='none';
  wizardOut.innerHTML='';
  insertBtn.disabled=true;
});

/* ===== Autosave tick ensure wizard insertion saved ===== */
setInterval(()=>{ if(planDirty) savePlan(); },5000);

</script>
</body>
</html>
