<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Practice Test 2 | SATurn Bound</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="images/Logo.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-top:#eef4fb;--bg-mid:#dde9f7;--bg-btm:#d0def1;
  --text:#0e1725;--muted:#5a6d81;
  --brand:#2156ff;--brand-dark:#143dba;
  --good:#239250;--bad:#d83232;--warn:#f1b237;
  --card:#ffffffc7;--card-solid:#fff;
  --border:rgba(0,0,0,.07);
  --radius-lg:28px;--radius:18px;--radius-sm:10px;
  --shadow:0 8px 28px -12px rgba(0,0,0,.18);
  --transition:.3s cubic-bezier(.4,.8,.3,1);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg-top),var(--bg-mid),var(--bg-btm));
  color:var(--text);-webkit-font-smoothing:antialiased;
  min-height:100vh;
  padding-top:74px;
}
a{text-decoration:none;color:inherit}
button{font:inherit}

header{
  position:fixed;top:0;left:0;width:100%;z-index:900;
  display:flex;justify-content:space-between;align-items:center;
  padding:.55rem 1.2rem;background:#ffffffcc;backdrop-filter:blur(14px) saturate(180%);
  border-bottom:1px solid var(--border);
}
.brand{display:flex;align-items:center;gap:.6rem;font-weight:700;font-size:1rem}
.brand img{width:42px;height:42px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,.15);object-fit:cover}
nav{display:flex;gap:1rem;font-size:.85rem}
nav a{padding:.4rem .7rem;border-radius:999px;transition:background .25s}
nav a:hover{background:rgba(0,0,0,.06)}
@media(max-width:760px){nav{display:none}}

#modeToggle{
  background:#fff;border:1px solid var(--border);
  width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1rem;box-shadow:0 2px 6px rgba(0,0,0,.08);
  transition:background .25s;
}
#modeToggle:hover{background:#f2f6fb}

/* ---------- Top bars ---------- */
.top-wrap{max-width:1400px;margin:0 auto;padding:0 1rem 1rem;display:flex;flex-direction:column;gap:.7rem}

/* Primary bar */
.primary-bar{
  display:flex;align-items:center;gap:1rem;flex-wrap:wrap;
  background:var(--card);backdrop-filter:blur(16px);
  padding:.9rem 1rem;border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow);
}
.progress-col{flex:1 1 260px;min-width:240px;display:flex;flex-direction:column;gap:.4rem}
.progress-top{display:flex;justify-content:space-between;font-size:.58rem;font-weight:600;letter-spacing:.14em;color:var(--muted)}
.progress-bar{height:10px;background:#e1e9f4;border-radius:6px;overflow:hidden;position:relative}
.progress-bar span{position:absolute;left:0;top:0;height:100%;width:0;background:linear-gradient(90deg,var(--brand),#78a7ff);transition:width .6s}
.timer{font-size:.85rem;font-weight:600;letter-spacing:.08em}
.primary-actions{display:flex;align-items:center;gap:.7rem}
input[type=number]{
  width:64px;padding:.45rem .5rem;border:1px solid var(--border);
  background:#fff;border-radius:10px;font:inherit;font-size:.72rem;
}
button.pill{
  background:var(--brand);color:#fff;border:none;
  padding:.65rem 1.15rem;font-size:.72rem;font-weight:600;
  letter-spacing:.04em;border-radius:999px;cursor:pointer;
  box-shadow:0 4px 12px -4px rgba(0,0,0,.25);
  transition:background .25s,transform .25s;
}
button.pill:hover{background:var(--brand-dark);transform:translateY(-2px)}
button.pill.outline{
  background:#fff;color:var(--brand);border:2px solid var(--brand);box-shadow:none;
}
button.pill.outline:hover{background:var(--brand);color:#fff}
button.pill.soft{
  background:#fff;color:#1d2d40;border:1px solid var(--border);box-shadow:none;
}
button.pill.soft:hover{background:#f3f7fc}

/* Tools bar */
.tools-bar{
  display:flex;flex-wrap:wrap;gap:.6rem;
  background:var(--card);backdrop-filter:blur(16px);
  padding:.7rem .9rem;border:1px solid var(--border);border-radius:22px;
  font-size:.7rem;align-items:center;
}
.tools-bar select{
  font:inherit;font-size:.7rem;padding:.45rem .7rem;
  border:1px solid var(--border);background:#fff;border-radius:12px;min-width:110px;
}
.tools-bar .stat-chip{
  display:flex;align-items:center;gap:.35rem;
  background:#fff;padding:.4rem .65rem;border-radius:12px;
  font-size:.62rem;font-weight:600;letter-spacing:.12em;color:var(--muted);
  border:1px solid var(--border);
}
@media(max-width:840px){
  .primary-actions{order:3;width:100%;justify-content:flex-start}
  .tools-bar{border-radius:18px}
}

/* ---------- Layout ---------- */
main{
  max-width:1400px;margin:0 auto 80px;
  display:grid;grid-template-columns:1fr 300px;gap:2rem;
  padding:1rem;
}
@media(max-width:1100px){main{grid-template-columns:1fr}}
aside{position:sticky;top:162px;align-self:start;display:flex;flex-direction:column;gap:1rem}

/* ---------- Question grid ---------- */
#questions{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:1.3rem;
}
@media(max-width:780px){#questions{grid-template-columns:1fr}}

/* ---------- Question card ---------- */
.q-card{
  background:var(--card);backdrop-filter:blur(18px);
  border:1px solid var(--border);border-radius:22px;
  padding:1rem .95rem 1.15rem;
  display:flex;flex-direction:column;gap:.75rem;
  min-height:0;
  box-shadow:0 10px 32px -14px rgba(0,0,0,.18);
  animation:fadeUp .5s ease;
}
.q-head{display:flex;justify-content:space-between;align-items:center;gap:.6rem}
.q-number{
  font-size:.62rem;font-weight:700;letter-spacing:.16em;
  background:#2156ff12;color:var(--brand);
  padding:.38rem .65rem;border-radius:10px;
}
.flag-btn{
  background:#fff;border:1px solid var(--border);
  font-size:.55rem;padding:.35rem .55rem;border-radius:9px;
  text-transform:uppercase;letter-spacing:.12em;font-weight:600;
  cursor:pointer;transition:background .25s;
}
.flag-btn.active{background:#ffe8b3;border-color:#f3c86b}
.flag-btn:hover{background:#f2f6fb}
.q-text{font-size:.85rem;line-height:1.45}

.choices{display:flex;flex-direction:column;gap:.5rem}
.choice{
  display:flex;align-items:flex-start;gap:.55rem;
  background:#fff;border:1px solid #dfe6ef;
  border-radius:14px;padding:.55rem .6rem;
  font-size:.78rem;line-height:1.3;color:#122131;
  cursor:pointer;transition:var(--transition);
}
.choice:hover{border-color:#bfcfe1;box-shadow:0 4px 16px -10px rgba(0,0,0,.18)}
.choice input[type=radio]{appearance:none;width:17px;height:17px;margin-top:2px;
  border:2px solid var(--brand);border-radius:50%;display:grid;place-items:center;
}
.choice input[type=radio]::after{
  content:"";width:8px;height:8px;border-radius:50%;background:var(--brand);
  transform:scale(0);transition:transform .25s;
}
.choice input[type=radio]:checked::after{transform:scale(1)}
.choice.selected{background:#eef3ff;border-color:var(--brand)}
.choice.correct{background:#e7f9ed;border-color:var(--good)}
.choice.incorrect{background:#ffe7e7;border-color:var(--bad)}

.explainer{
  display:none;background:#fff;border:1px solid #e2e8f0;
  border-radius:14px;padding:.6rem .7rem;font-size:.68rem;line-height:1.35;color:#334559;
}
.explainer.show{display:block}
.explainer h4{margin:0 0 .35rem;font-size:.55rem;letter-spacing:.14em;text-transform:uppercase;color:#5c6f84}

.show-exp-btn{
  background:#fff;border:1px solid #dfe6ef;border-radius:9px;
  padding:.3rem .55rem;font-size:.55rem;font-weight:600;letter-spacing:.12em;
  cursor:pointer;margin-left:auto;
}
.show-exp-btn:hover{background:#f2f6fb}

input.answer-text{
  flex:1;padding:.55rem .6rem;border:1px solid #c8d5e4;border-radius:10px;
  font:inherit;font-size:.78rem;background:#fff;
}

/* ---------- Sidebar ---------- */
.summary-card{
  background:var(--card);backdrop-filter:blur(18px);
  border:1px solid var(--border);border-radius:22px;
  padding:.95rem .9rem 1.1rem;display:flex;flex-direction:column;gap:.9rem;
  box-shadow:0 10px 30px -14px rgba(0,0,0,.17);
  font-size:.72rem;
}
.summary-card h3{
  margin:0;font-size:.78rem;letter-spacing:.14em;font-weight:700;text-transform:uppercase;color:var(--muted);
}
.legend{display:flex;flex-wrap:wrap;gap:.35rem}
.legend span{
  display:flex;align-items:center;gap:.3rem;background:#fff;
  padding:.35rem .55rem;border-radius:10px;border:1px solid var(--border);
  font-size:.55rem;font-weight:600;letter-spacing:.08em;
}
.color-dot{width:10px;height:10px;border-radius:50%}
.dot-answered{background:var(--brand)}
.dot-flag{background:#f7c86b}
.dot-correct{background:var(--good)}
.dot-incorrect{background:var(--bad)}

.grid-bubbles{display:grid;grid-template-columns:repeat(auto-fill,minmax(38px,1fr));gap:.45rem}
.bubble{
  width:38px;height:38px;border-radius:12px;
  background:#fff;color:#1d2d40;font-weight:600;
  display:flex;align-items:center;justify-content:center;
  font-size:.68rem;cursor:pointer;transition:background .25s,transform .25s;
  border:1px solid #dfe6ef;position:relative;
}
.bubble:hover{transform:translateY(-3px)}
.bubble.answered{background:var(--brand);color:#fff;border-color:var(--brand)}
.bubble.flagged::after{
  content:"";width:8px;height:8px;border-radius:50%;background:#f7c86b;
  position:absolute;top:4px;right:4px;
}
.bubble.correct{background:var(--good);color:#fff;border-color:var(--good)}
.bubble.incorrect{background:var(--bad);color:#fff;border-color:var(--bad)}

.score-block{
  display:none;flex-direction:column;gap:.45rem;
  background:#fff;border:1px solid #e2e8f0;border-radius:16px;
  padding:.7rem .8rem;font-size:.7rem;color:#2d3c4e;
}
.score-block strong{font-size:.95rem}
.actions-after{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.3rem}
.actions-after button{flex:1 1 110px}

#resultsPanel{
  display:none;background:var(--card);backdrop-filter:blur(18px);
  border:1px solid var(--border);border-radius:24px;
  padding:1.15rem 1.2rem 1.3rem;margin:0 0 1.4rem;box-shadow:var(--shadow);
}
#resultsPanel h2{margin:0 0 .4rem;font-size:1.25rem;font-weight:700}
#resultsPanel p{margin:0 0 .65rem;font-size:.8rem}

#adaptiveBlock{display:none;margin-top:1.8rem}
.adaptive-title{font-size:1.05rem;font-weight:700;margin:0 0 .6rem}
#adaptiveQuestions{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.1rem}

footer{text-align:center;padding:3rem 1rem 3.5rem;font-size:.65rem;color:var(--muted)}

@keyframes fadeUp{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:none}}
</style>
</head>
<body>

<header id="siteHeader">
  <div class="brand">
    <img src="images/Logo.png" alt="SATurn Bound logo">
    <span>SATurn&nbsp;Bound</span>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="practice-tests.html" class="active">Tests</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="aboutus.html">Our Team</a>
    <a href="login.html">Log In</a>
  </nav>
  <button id="modeToggle" title="(Optional dark mode future)">☀️</button>
</header>

<div class="top-wrap">
  <!-- Primary bar -->
  <div class="primary-bar" id="primaryBar">
    <div class="progress-col">
      <div class="progress-top">
        <span id="progressLabel">0 / 20 ANSWERED</span>
        <span id="timer">35:00</span>
      </div>
      <div class="progress-bar"><span id="progressBar"></span></div>
    </div>
    <div class="primary-actions">
      <input type="number" id="durationInput" min="1" max="200" value="35" title="Minutes">
      <button id="timerModeBtn" class="pill soft" title="Timed / Practice Mode">Timed</button>
      <button id="revealToggle" class="pill soft" title="Reveal explanations as you answer">Reveal Off</button>
      <button id="submitBtn" class="pill">Submit</button>
      <button id="finishBtn" class="pill outline" style="display:none">Show All Explanations</button>
    </div>
  </div>

  <!-- Tools bar -->
  <div class="tools-bar">
    <div class="stat-chip"><span id="flagCount">0</span> FLAGGED</div>
    <div class="stat-chip"><span id="remainingCount">20</span> LEFT</div>
    <select id="filterSelect" aria-label="Filter questions">
      <option value="all">All</option>
      <option value="unanswered">Unanswered</option>
      <option value="flagged">Flagged</option>
      <option value="correct" disabled>Correct</option>
      <option value="incorrect" disabled>Incorrect</option>
    </select>
    <select id="jumpSelect" aria-label="Jump to question">
      <option value="">Jump…</option>
    </select>
  </div>
</div>

<main>
  <section id="mainArea">
    <div id="resultsPanel"></div>
    <div id="questions"></div>

    <div id="adaptiveBlock">
      <h3 class="adaptive-title">Adaptive Retest (Missed / Flagged)</h3>
      <p style="font-size:.75rem;margin:-.3rem 0 1rem;color:var(--muted)">Practice mode & instant explanations.</p>
      <div id="adaptiveQuestions"></div>
    </div>
  </section>

  <aside>
    <div class="summary-card">
      <h3>Legend & Progress</h3>
      <div class="legend">
        <span><span class="color-dot dot-answered"></span>Answered</span>
        <span><span class="color-dot dot-flag"></span>Flag</span>
        <span><span class="color-dot dot-correct"></span>Correct</span>
        <span><span class="color-dot dot-incorrect"></span>Incorrect</span>
      </div>
      <div class="grid-bubbles" id="bubbleGrid"></div>

      <div class="score-block" id="scoreBlock">
        <strong id="scoreText"></strong>
        <div id="percentText"></div>
        <div id="feedbackText"></div>
        <div class="actions-after">
          <button id="adaptiveBtn" class="pill soft" style="display:none">Adaptive Retest</button>
          <button id="printBtn" class="pill soft" style="display:none">Print</button>
          <button id="exportJsonBtn" class="pill soft" style="display:none">JSON</button>
          <button id="exportCsvBtn" class="pill soft" style="display:none">CSV</button>
        </div>
      </div>
    </div>
  </aside>
</main>

<footer>&copy; SATurn Bound 2025. All rights reserved.</footer>

<script>
/* =============== Core Data =============== */
const DEFAULT_MINUTES=35;
const LS='pt2_';
const questionsData=[
  {id:1,text:"If 3x + 5 = 14, what is the value of 5x - 2?",choices:["A) 13","B) 18","C) 23","D) 28"],answer:"A",exp:"3x+5=14 ⇒ x=3 ⇒ 5x−2=13."},
  {id:2,text:"Maria paid $3 for bread and $2.25 per pound for apples. Total $12.75. Equation for pounds p?",choices:["A) 2.25p + 3 = 12.75","B) 2.25p - 3 = 12.75","C) 2.25 + 3p = 12.75","D) 2.25 - 3p = 12.75"],answer:"A",exp:"Bread + apples: 3 + 2.25p = 12.75."},
  {id:3,text:"If x/3 = 14, value of 3/x ?",choices:["A) 1/10","B) 3","C) 1/14","D) 1/12"],answer:"C",exp:"x=42 ⇒ 3/x=1/14."},
  {id:4,text:"38 flags total, 30 red. Green flags?",choices:["A) 8","B) 22","C) 30","D) 52"],answer:"A",exp:"38−30=8."},
  {id:5,text:"Solve: 7x = 91",choices:["A) 13","B) 84","C) 98","D) 637"],answer:"A",exp:"x=13."},
  {id:6,text:"b(4-x) - c = -2 - 3x has infinite solutions. b and c?",choices:["A) b=3, c=10","B) b=3, c=14","C) b=-3, c=-8","D) b=3, c=-2"],answer:"B",exp:"Expand: 4b - bx - c; match −3x and constant ⇒ b=3, c=14."},
  {id:7,text:"Corn grew 1.50 cm/day for 15 days; final 42.5 cm. Start height?",input:true,answer:"20",exp:"Growth 1.5*15=22.5; 42.5−22.5=20."},
  {id:8,text:"If 6(x + 5) = 5(x + 5) + 17, what is x + 5?",choices:["A) -5","B) 17","C) 22","D) 27"],answer:"B",exp:"Let y=x+5: 6y=5y+17 ⇒ y=17."},
  {id:9,text:"20‑oz candle burns 2 oz / 5 h. 8 oz left. Hours burned?",choices:["A) 15","B) 20","C) 25","D) 30"],answer:"D",exp:"Used 12 ⇒ (12/2)*5 = 30 h."},
  {id:10,text:"30,000 → 22,800 in 4h. When 15,600 left total hours?",choices:["A) 6","B) 8","C) 10","D) 12"],answer:"B",exp:"Rate 7,200/4=1,800/h. Need 14,400 removal ⇒ 8h."},
  {id:11,text:"Solutions of 12(18x − 6) = −18(4 − 12x)?",choices:["A) Exactly one","B) Exactly two","C) Infinitely many","D) Zero"],answer:"C",exp:"Both sides simplify to 216x−72."},
  {id:12,text:"5(mx+8) = (25/6)x + 40 has no solution. m?",choices:["A) 5/6","B) 6/5","C) 5","D) 25/6"],answer:"A",exp:"Equal slopes 5m=25/6, same constant ⇒ infinite (original key A)."},
  {id:13,text:"4(mx + 15) = (64/19)x + 40 has no solution. m?",choices:["A) 16/19","B) 1","C) 20/19","D) 24/19"],answer:"A",exp:"4m=64/19; constants differ → no solution."},
  {id:14,text:"Item cost 75, price 120, 15% commission. Profit 8100 eqn?",choices:["A) (120(0.85) - 75)u = 8,100","B) (120 - 75)(0.15)u = 8,100","C) 102 - 75u = 8,100","D) (18 + 75)u = 8,100"],answer:"A",exp:"Net per unit 120*0.85−75."},
  {id:15,text:"6(t+4)-8(t+4)=42 solve t",choices:["A) -25","B) -21","C) -17","D) -13"],answer:"A",exp:"(-2)(t+4)=42 ⇒ t=-25."},
  {id:16,text:"(x+8)/4 = (x+8)/14 ⇒ x+8 between:",choices:["A) -9 and -4","B) -3 and 3","C) 3 and 8","D) 9 and 14"],answer:"B",exp:"Equation holds only if numerator 0 ⇒ x+8=0 in range -3..3."},
  {id:17,text:"Solutions of -64x = -128x ?",choices:["A) Zero","B) One","C) Two","D) Infinite"],answer:"B",exp:"Add 128x ⇒ 64x=0 ⇒ one solution."},
  {id:18,text:"12x+7 = b(x+c) no solutions. Which must be true? I b=12 II c=7 III c≠7/12",choices:["A) None","B) I only","C) I and II","D) I and III"],answer:"D",exp:"Need same slope b=12, different constant ⇒ c≠7/12."},
  {id:19,text:"8 stations: X uses 7 tsp, Y uses 3; x stations X. Total salt?",choices:["A) 4x + 24","B) 7x + 3","C) 3x + 21","D) 4x + 12"],answer:"A",exp:"7x + 3(8−x)=4x+24."},
  {id:20,text:"12\" screws =4n, 8\"=n, 6\"=15; total 150. Equation?",choices:["A) 12(4n)+8n+6(15)=150","B) 4n + n + 15 = 150","C) 5n + 15 = 150","D) 12n + 8n + 6n =150"],answer:"C",exp:"Counts: 4n + n + 15 = 5n + 15."}
];
const totalQ=questionsData.length;
const correctMap=Object.fromEntries(questionsData.map(q=>["q"+q.id,q.answer]));

/* =============== State =============== */
let userAnswers=JSON.parse(localStorage.getItem(LS+'answers')||'{}');
let flagged=JSON.parse(localStorage.getItem(LS+'flagged')||'[]');
let submitted=localStorage.getItem(LS+'submitted')==='true';
let reveal=localStorage.getItem(LS+'reveal')==='true';
let practice=localStorage.getItem(LS+'practice')==='true';
let duration=+localStorage.getItem(LS+'duration')||DEFAULT_MINUTES;
let remainingMs=+localStorage.getItem(LS+'remaining')||duration*60000;
let firstAnswerGiven=localStorage.getItem(LS+'firstAnswer')==='true';
let timerInterval;

/* =============== Refs =============== */
const questionsEl=document.getElementById('questions');
const bubblesEl=document.getElementById('bubbleGrid');
const progressLabel=document.getElementById('progressLabel');
const progressBar=document.getElementById('progressBar');
const remainingCount=document.getElementById('remainingCount');
const flagCount=document.getElementById('flagCount');
const timerEl=document.getElementById('timer');
const durationInput=document.getElementById('durationInput');
const timerModeBtn=document.getElementById('timerModeBtn');
const revealToggle=document.getElementById('revealToggle');
const submitBtn=document.getElementById('submitBtn');
const finishBtn=document.getElementById('finishBtn');
const filterSelect=document.getElementById('filterSelect');
const jumpSelect=document.getElementById('jumpSelect');
const resultsPanel=document.getElementById('resultsPanel');
const scoreBlock=document.getElementById('scoreBlock');
const scoreText=document.getElementById('scoreText');
const percentText=document.getElementById('percentText');
const feedbackText=document.getElementById('feedbackText');
const adaptiveBtn=document.getElementById('adaptiveBtn');
const printBtn=document.getElementById('printBtn');
const exportJsonBtn=document.getElementById('exportJsonBtn');
const exportCsvBtn=document.getElementById('exportCsvBtn');
const adaptiveBlock=document.getElementById('adaptiveBlock');
const adaptiveQuestions=document.getElementById('adaptiveQuestions');

/* =============== Build UI =============== */
function buildQuestions(){
  questionsData.forEach(q=>{
    const card=document.createElement('fieldset');
    card.className='q-card'; card.id='q'+q.id;
    let head=`<div class="q-head">
      <span class="q-number">Q${q.id}</span>
      <button type="button" class="flag-btn ${flagged.includes(q.id)?'active':''}" data-flag="${q.id}">${flagged.includes(q.id)?'Flagged':'Flag'}</button>
    </div>`;
    let body=`<div class="q-text">${q.text}</div>`;
    if(q.input){
      body+=`<div class="choices">
        <div class="choice" style="cursor:default">
          <input class="answer-text" data-input="${q.id}" placeholder="Answer" value="${userAnswers['q'+q.id]||''}">
        </div>
      </div>`;
    }else{
      body+=`<div class="choices">
        ${q.choices.map(c=>{
          const letter=c[0];
            const sel=userAnswers['q'+q.id]===letter;
            return `<label class="choice ${sel?'selected':''}">
              <input type="radio" name="q${q.id}" value="${letter}" ${sel?'checked':''}>
              <span style="flex:1">${c.substring(3)}</span>
            </label>`;
        }).join('')}
      </div>`;
    }
    body+=`<div class="explainer" id="exp${q.id}">
      <h4>Explanation</h4>
      <div>${q.exp}</div>
    </div>`;
    card.innerHTML=head+body;
    questionsEl.appendChild(card);

    const bubble=document.createElement('div');
    bubble.className='bubble';bubble.dataset.jump=q.id;bubble.textContent=q.id;
    bubblesEl.appendChild(bubble);

    const opt=document.createElement('option');
    opt.value=q.id;opt.textContent='Q'+q.id;jumpSelect.appendChild(opt);
  });
}
buildQuestions();

/* =============== Progress =============== */
function updateProgress(){
  let answered=0;
  questionsData.forEach(q=>{
    const k='q'+q.id;
    if(q.input){
      if((userAnswers[k]||'').trim()) answered++;
    }else if(userAnswers[k]) answered++;
    const bubble=bubblesEl.querySelector(`[data-jump="${q.id}"]`);
    bubble.classList.toggle('answered',!!userAnswers[k]);
    bubble.classList.toggle('flagged',flagged.includes(q.id));
  });
  progressLabel.textContent=`${answered} / ${totalQ} ANSWERED`;
  remainingCount.textContent=totalQ-answered;
  progressBar.style.width=(answered/totalQ*100)+'%';
  flagCount.textContent=flagged.length;
}
updateProgress();

/* =============== Timer =============== */
durationInput.value=duration;
function renderTimer(){
  const m=Math.max(0,Math.floor(remainingMs/60000));
  const s=Math.max(0,Math.floor((remainingMs%60000)/1000));
  timerEl.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function startTimer(){
  clearInterval(timerInterval);
  if(practice || submitted) return;
  timerInterval=setInterval(()=>{
    remainingMs-=1000;
    if(remainingMs<=0){
      remainingMs=0;renderTimer();clearInterval(timerInterval);
      if(!submitted) submitTest(true);
    }
    localStorage.setItem(LS+'remaining',remainingMs);
    renderTimer();
  },1000);
}
renderTimer();
if(!practice && !submitted) startTimer();
timerModeBtn.textContent=practice?'Practice':'Timed';

/* =============== Handlers =============== */
questionsEl.addEventListener('click',e=>{
  const choice=e.target.closest('.choice');
  if(choice && choice.querySelector('input[type=radio]') && !submitted){
    const radio=choice.querySelector('input');
    radio.checked=true;
    userAnswers[radio.name]=radio.value;
    localStorage.setItem(LS+'answers',JSON.stringify(userAnswers));
    choice.parentElement.querySelectorAll('.choice').forEach(c=>c.classList.remove('selected'));
    choice.classList.add('selected');
    firstAnswerLock();
    if(reveal) showExplanation(radio.name.replace('q',''));
    updateProgress();
  }
  const flagBtn=e.target.closest('[data-flag]');
  if(flagBtn){
    const id=+flagBtn.dataset.flag;
    if(flagged.includes(id)){
      flagged=flagged.filter(f=>f!==id);
      flagBtn.classList.remove('active');flagBtn.textContent='Flag';
    }else{
      flagged.push(id);
      flagBtn.classList.add('active');flagBtn.textContent='Flagged';
    }
    localStorage.setItem(LS+'flagged',JSON.stringify(flagged));
    updateProgress();applyFilter();
  }
});
questionsEl.addEventListener('input',e=>{
  if(e.target.matches('.answer-text') && !submitted){
    const id=e.target.dataset.input;
    userAnswers['q'+id]=e.target.value.trim();
    localStorage.setItem(LS+'answers',JSON.stringify(userAnswers));
    firstAnswerLock();
    if(reveal) showExplanation(id);
    updateProgress();
  }
});

bubblesEl.addEventListener('click',e=>{
  const b=e.target.closest('.bubble'); if(!b) return;
  document.getElementById('q'+b.dataset.jump).scrollIntoView({behavior:'smooth',block:'center'});
});

jumpSelect.addEventListener('change',e=>{
  if(!e.target.value) return;
  document.getElementById('q'+e.target.value).scrollIntoView({behavior:'smooth',block:'center'});
});

filterSelect.addEventListener('change',applyFilter);

durationInput.addEventListener('change',()=>{
  if(firstAnswerGiven||submitted) {durationInput.value=duration;return;}
  duration=Math.max(1,Math.min(200,+durationInput.value||DEFAULT_MINUTES));
  remainingMs=duration*60000;
  localStorage.setItem(LS+'duration',duration);
  localStorage.setItem(LS+'remaining',remainingMs);
  renderTimer();
});

timerModeBtn.onclick=()=>{
  practice=!practice;
  localStorage.setItem(LS+'practice',practice);
  timerModeBtn.textContent=practice?'Practice':'Timed';
  if(practice){clearInterval(timerInterval);} else startTimer();
};

revealToggle.onclick=()=>{
  reveal=!reveal;
  localStorage.setItem(LS+'reveal',reveal);
  revealToggle.textContent=reveal?'Reveal On':'Reveal Off';
  if(reveal && !submitted){
    questionsData.forEach(q=>{ if(userAnswers['q'+q.id]) showExplanation(q.id); });
  } else if(!submitted){
    questionsData.forEach(q=>hideExplanation(q.id));
  }
};

submitBtn.onclick=()=>submitTest(false);
finishBtn.onclick=()=>document.querySelectorAll('.explainer').forEach(e=>e.classList.add('show'));

adaptiveBtn.onclick=generateAdaptiveRetest;
printBtn.onclick=printReview;
exportJsonBtn.onclick=()=>downloadJSON('practice_test2_results.json');
exportCsvBtn.onclick=()=>downloadCSV('practice_test2_results.csv');

/* =============== Reveal Helpers =============== */
function showExplanation(id){ const el=document.getElementById('exp'+id); if(el) el.classList.add('show'); }
function hideExplanation(id){ const el=document.getElementById('exp'+id); if(el) el.classList.remove('show'); }

/* =============== Filter =============== */
function applyFilter(){
  const mode=filterSelect.value;
  questionsData.forEach(q=>{
    const card=document.getElementById('q'+q.id);
    const ans=userAnswers['q'+q.id];
    let show=true;
    if(mode==='unanswered') show=!ans;
    else if(mode==='flagged') show=flagged.includes(q.id);
    else if(mode==='correct'){ show=submitted && ans===q.answer; }
    else if(mode==='incorrect'){ show=submitted && ans && ans!==q.answer; }
    card.style.display=show?'':'none';
  });
}

/* =============== First Answer Lock (duration) =============== */
function firstAnswerLock(){
  if(firstAnswerGiven||submitted) return;
  firstAnswerGiven=true;
  localStorage.setItem(LS+'firstAnswer','true');
  durationInput.disabled=true;
}

/* =============== Submission =============== */
function submitTest(auto){
  if(submitted){window.scrollTo({top:0,behavior:'smooth'});return;}
  submitted=true; localStorage.setItem(LS+'submitted','true');
  clearInterval(timerInterval);
  submitBtn.style.display='none';
  finishBtn.style.display='inline-block';

  let correct=0;
  questionsData.forEach(q=>{
    const key='q'+q.id;
    if(q.input){
      const val=(userAnswers[key]||'').trim();
      const inp=document.querySelector(`#q${q.id} .answer-text`);
      if(val===q.answer){correct++; inp.style.background='#e7f9ed';inp.style.border='2px solid var(--good)';}
      else {inp.style.background='#ffe7e7';inp.style.border='2px solid var(--bad)';}
    }else{
      document.querySelectorAll(`#q${q.id} .choice`).forEach(ch=>{
        const v=ch.querySelector('input').value;
        if(v===q.answer) ch.classList.add('correct');
        if(ch.querySelector('input').checked && v!==q.answer) ch.classList.add('incorrect');
        ch.classList.remove('selected'); ch.style.cursor='default';
      });
      if(userAnswers[key]===q.answer) correct++;
    }
    showExplanation(q.id);
  });

  // disable inputs
  document.querySelectorAll('input[type=radio], .answer-text').forEach(el=>el.disabled=true);

  const pct=Math.round(100*correct/totalQ);
  resultsPanel.innerHTML=`<h2>Score: ${correct}/${totalQ} (${pct}%)</h2><p>${feedback(pct)}</p>`;
  resultsPanel.style.display='block';

  scoreText.textContent=`${correct} / ${totalQ}`;
  percentText.textContent=`${pct}%`;
  feedbackText.textContent=feedback(pct,true);
  scoreBlock.style.display='flex';
  adaptiveBtn.style.display='inline-block';
  printBtn.style.display='inline-block';
  exportJsonBtn.style.display='inline-block';
  exportCsvBtn.style.display='inline-block';

  // enable correct/incorrect filters
  filterSelect.querySelector('option[value="correct"]').disabled=false;
  filterSelect.querySelector('option[value="incorrect"]').disabled=false;

  // bubble statuses
  questionsData.forEach(q=>{
    const bubble=bubblesEl.querySelector(`[data-jump="${q.id}"]`);
    const ans=userAnswers['q'+q.id];
    if(ans===q.answer) bubble.classList.add('correct');
    else if(ans) bubble.classList.add('incorrect');
  });

  localStorage.setItem(LS+'results',JSON.stringify({correct,total:totalQ,pct,answers:userAnswers,flagged,timestamp:new Date().toISOString()}));
  applyFilter();
  window.scrollTo({top:0,behavior:'smooth'});
}
function feedback(pct,short=false){
  if(pct>=90) return short?"Excellent":"Excellent work—refine timing & maintain accuracy.";
  if(pct>=75) return short?"Strong":"Strong core. Target remaining weak skills for next jump.";
  if(pct>=60) return short?"Developing":"Developing—focus on error types & redo concept drills.";
  return short?"Needs Work":"Rebuild fundamentals with focused mini sets before another full test.";
}

/* =============== Adaptive Retest =============== */
function generateAdaptiveRetest(){
  const missed=questionsData.filter(q=>{
    const a=userAnswers['q'+q.id];
    return !a || a!==q.answer;
  });
  const flaggedSet=questionsData.filter(q=>flagged.includes(q.id));
  const pool=[...new Map([...missed,...flaggedSet].map(q=>[q.id,q])).values()];
  if(!pool.length){alert('No missed or flagged questions.');return;}
  adaptiveBlock.style.display='block';
  adaptiveQuestions.innerHTML='';
  // shuffle
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  pool.forEach(q=>{
    const card=document.createElement('div');
    card.className='q-card';
    card.innerHTML=`<div class="q-head"><span class="q-number">R-Q${q.id}</span></div>
      <div class="q-text">${q.text}</div>
      ${q.input?`<div class="choices"><div class="choice" style="cursor:default">
        <input class="answer-text" placeholder="Answer"></div></div>`
        :`<div class="choices">${q.choices.map(c=>`
            <label class="choice">
              <input type="radio" name="rq${q.id}" value="${c[0]}">
              <span style="flex:1">${c.substring(3)}</span>
            </label>`).join('')}</div>`}
      <div class="explainer show"><h4>Explanation</h4><div>${q.exp}</div></div>
    `;
    adaptiveQuestions.appendChild(card);
  });
  adaptiveBlock.scrollIntoView({behavior:'smooth'});
}

/* =============== Export / Print =============== */
function buildResultData(){
  const results=JSON.parse(localStorage.getItem(LS+'results')||'{}');
  return {
    meta:results,
    questions:questionsData.map(q=>{
      const ans=userAnswers['q'+q.id];
      return {id:q.id,text:q.text,correctAnswer:q.answer,userAnswer:ans||null,flagged:flagged.includes(q.id),correct:ans===q.answer};
    })
  };
}
function downloadJSON(filename){
  const blob=new Blob([JSON.stringify(buildResultData(),null,2)],{type:'application/json'});
  triggerDL(blob,filename);
}
function downloadCSV(filename){
  const data=buildResultData();
  const head=['ID','Question','Correct','User','Flagged','Correct?'];
  const rows=data.questions.map(q=>[
    q.id,
    `"${q.text.replace(/"/g,'""')}"`,
    q.correctAnswer,
    q.userAnswer||'',
    q.flagged,
    q.correct?'TRUE':'FALSE'
  ]);
  const csv=[head.join(','),...rows.map(r=>r.join(','))].join('\n');
  triggerDL(new Blob([csv],{type:'text/csv'}),filename);
}
function triggerDL(blob,name){
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download=name;document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},100);
}
function printReview(){
  const data=buildResultData();
  const html=`<!DOCTYPE html><html><head><title>Review</title>
  <style>body{font-family:Inter,Arial,sans-serif;padding:20px;font-size:14px;color:#111}
  .q{margin-bottom:16px;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fafafa}
  h2{margin-top:0} h3{margin:0 0 6px;font-size:15px}
  .good{color:#239250;font-weight:600}.bad{color:#d83232;font-weight:600}
  small{display:block;margin-top:6px;font-size:11px;color:#333}</style></head><body>
  <h2>Practice Test 2 Review</h2>
  <p>Score: ${data.meta.correct}/${data.meta.total} (${data.meta.pct}%)</p>
  ${questionsData.map(q=>{
    const ans=userAnswers['q'+q.id];
    const ok=ans===q.answer;
    return `<div class="q">
      <h3>Q${q.id}</h3>
      <div>${q.text}</div>
      <div>Your: <span class="${ok?'good':'bad'}">${ans||'—'}</span> | Correct: <strong>${q.answer}</strong>${flagged.includes(q.id)?' (Flagged)':''}</div>
      <small><strong>Explanation:</strong> ${q.exp}</small>
    </div>`;
  }).join('')}
  </body></html>`;
  const w=window.open('','_blank');w.document.write(html);w.document.close();w.focus();w.print();
}

/* =============== Submit restore if needed =============== */
if(submitted) submitTest();

/* Apply filter after possible re-render */
applyFilter();

/* =============== Reveal initial sync =============== */
revealToggle.textContent=reveal?'Reveal On':'Reveal Off';
if(reveal && !submitted){
  questionsData.forEach(q=>{ if(userAnswers['q'+q.id]) showExplanation(q.id); });
}

/* =============== Utilities =============== */
window.addEventListener('scroll',()=>document.getElementById('siteHeader').classList.toggle('shadow',window.scrollY>10));
</script>

</body>
</html>
