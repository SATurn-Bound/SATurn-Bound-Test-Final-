<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SATurn Bound | Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="images/Logo.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --navy:#061a48;
  --navy-dk:#041230;
  --grad-bg:radial-gradient(circle at 30% 15%,#0d2d78,#041230 70%);
  --panel:rgba(255,255,255,.55);
  --panel-solid:#ffffff;
  --accent:#2156ff;
  --accent-dk:#143dba;
  --good:#1c9c55;
  --bad:#d83232;
  --warn:#f3b432;
  --muted:#5b6c80;
  --radius-lg:30px;--radius:22px;--radius-sm:12px;
  --shadow:0 18px 46px -18px rgba(0,0,0,.45);
  --shadow-sm:0 6px 20px -8px rgba(0,0,0,.35);
  --bg:#061a48;
  --cream:#fff8e8;
  --grid-gap:1.8rem;
  --transition:.35s cubic-bezier(.19,1,.22,1);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,Arial,sans-serif;
  background:var(--grad-bg);
  color:#fff;
  -webkit-font-smoothing:antialiased;
  min-height:100vh;
  padding-top:70px;
  line-height:1.35;
}
a{text-decoration:none;color:inherit}
h1,h2,h3,h4{font-weight:600;line-height:1.15}
p{margin:0 0 .6rem}
header{
  position:fixed;top:0;left:0;width:100%;z-index:900;
  background:#0e1e4dea;
  backdrop-filter:blur(14px) saturate(160%);
  display:flex;justify-content:space-between;align-items:center;
  padding:.65rem 1.3rem;border-bottom:1px solid rgba(255,255,255,.12);
}
.brand{display:flex;align-items:center;gap:.7rem;font-weight:700;font-size:1rem}
.brand img{width:44px;height:44px;object-fit:cover;border-radius:50%;border:2px solid #fff}
nav{display:flex;gap:1.4rem;font-size:.85rem;font-weight:500}
nav a{padding:.45rem .85rem;border-radius:999px;transition:background .25s}
nav a:hover{background:rgba(255,255,255,.09)}
@media(max-width:760px){nav{display:none}}

main{max-width:1450px;margin:0 auto;padding:2.2rem 1.4rem 4rem;display:flex;flex-direction:column;gap:2.2rem}

/* Grid layout */
.dashboard-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:var(--grid-gap);
  align-items:start;
}

/* Panels */
.panel{
  background:var(--panel);
  backdrop-filter:blur(22px) saturate(160%);
  border:1px solid rgba(255,255,255,.35);
  border-radius:var(--radius);
  padding:1.15rem 1.2rem 1.25rem;
  box-shadow:var(--shadow-sm);
  display:flex;
  flex-direction:column;
  gap:.85rem;
  position:relative;
  overflow:hidden;
}
.panel h3{
  margin:0 0 .2rem;
  font-size:.95rem;
  letter-spacing:.5px;
  font-weight:700;
}
.small-label{
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.14em;
  opacity:.72;
  text-transform:uppercase;
}

.metric-row{display:flex;flex-wrap:wrap;gap:1rem}
.metric{
  background:#ffffff10;
  border:1px solid rgba(255,255,255,.22);
  padding:.75rem .85rem;
  border-radius:16px;
  min-width:130px;
  flex:1 1 120px;
  display:flex;
  flex-direction:column;
  gap:.35rem;
}
.metric strong{font-size:1.25rem;letter-spacing:.5px}
.metric span{font-size:.65rem;letter-spacing:.12em;opacity:.75;font-weight:600}

.progress-bar{
  position:relative;
  background:rgba(255,255,255,.18);
  height:10px;
  border-radius:6px;
  overflow:hidden;
}
.progress-bar span{
  position:absolute;left:0;top:0;height:100%;
  background:linear-gradient(90deg,#54a6ff,#f27891);
  width:0;
  transition:width .9s var(--transition);
}

/* Score gauge (simple ring) */
.score-gauge{
  width:140px;height:140px;
  margin:.4rem auto 0;
  position:relative;
}
.score-gauge svg{transform:rotate(-90deg)}
.score-gauge circle{
  fill:none;stroke-width:14;stroke-linecap:round;
}
.gauge-bg{stroke:rgba(255,255,255,.18)}
.gauge-val{stroke:url(#gradScore);stroke-dasharray:440;stroke-dashoffset:440;transition:stroke-dashoffset 1s var(--transition)}
.gauge-center{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  font-weight:600;
}
.gauge-center .big{font-size:1.55rem;letter-spacing:.5px}
.badge{
  display:inline-block;
  padding:.35rem .6rem;
  background:#fff;
  color:#061a48;
  border-radius:999px;
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.14em;
}
.badge.warn{background:#f3b432;color:#210}
.badge.good{background:#1c9c55;color:#fff}
.badge.bad{background:#d83232;color:#fff}

/* Study Plan */
#studyPlanEditor{
  min-height:180px;
  background:#ffffffcc;
  color:#18263a;
  border:1px solid #d0d9e3;
  border-radius:16px;
  padding:1rem;
  line-height:1.4;
  font-size:.85rem;
  overflow:auto;
  outline:none;
  box-shadow:0 4px 18px -8px rgba(0,0,0,.25);
}
#studyPlanEditor:empty:before{content:"Type your personalized plan goals, schedule, or tasks here...";opacity:.5}
.plan-actions{display:flex;flex-wrap:wrap;gap:.6rem}
.plan-actions button{
  background:#fff;
  border:1px solid #d0d9e3;
  color:#0f2540;
  font-size:.65rem;
  padding:.5rem .85rem;
  border-radius:12px;
  font-weight:600;
  letter-spacing:.05em;
  cursor:pointer;
  transition:background .25s;
}
.plan-actions button:hover{background:#eef3f9}

/* Table of attempts */
.attempts-table{
  width:100%;border-collapse:collapse;font-size:.7rem;
  overflow:hidden;border-radius:14px;
}
.attempts-table th, .attempts-table td{
  padding:.55rem .65rem;text-align:left;
}
.attempts-table thead{background:rgba(255,255,255,.15)}
.attempts-table tbody tr:nth-child(even){background:rgba(255,255,255,.08)}
.attempts-table tbody tr:hover{background:rgba(255,255,255,.18)}

.inline-tag{
  display:inline-block;
  padding:.3rem .5rem;
  font-size:.55rem;
  font-weight:600;
  border-radius:8px;
  background:#ffffff22;
  margin:.1rem .25rem .25rem 0;
  letter-spacing:.08em;
}

/* Skill bars */
.skill-bar-row{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.55rem}
.skill-label{
  display:flex;justify-content:space-between;font-size:.62rem;font-weight:600;letter-spacing:.08em;opacity:.85;
}
.skill-progress{
  height:8px;background:rgba(255,255,255,.18);border-radius:5px;overflow:hidden;position:relative;
}
.skill-progress span{
  position:absolute;top:0;left:0;height:100%;background:linear-gradient(90deg,#54a6ff,#f27891);
  width:0;transition:width 1s var(--transition);
}

/* Focus card */
.focus-pill{
  background:#fff;color:#061a48;
  padding:.55rem .85rem;
  border-radius:14px;
  font-size:.7rem;
  font-weight:600;
  letter-spacing:.05em;
  display:inline-flex;
  align-items:center;
  gap:.4rem;
  margin:.35rem .4rem .35rem 0;
}
.focus-pill.low{background:#d83232;color:#fff}
.focus-pill.mid{background:#f3b432;color:#341800}
.focus-pill.good{background:#1c9c55;color:#fff}

/* Buttons generic */
button.action{
  background:#2156ff;
  color:#fff;
  border:none;
  padding:.65rem 1.1rem;
  font-size:.7rem;
  font-weight:600;
  letter-spacing:.05em;
  border-radius:999px;
  cursor:pointer;
  box-shadow:0 4px 14px -4px rgba(0,0,0,.35);
  transition:background .25s, transform .25s;
}
button.action:hover{background:#143dba;transform:translateY(-2px)}
button.action.alt{
  background:#fff;color:#16315a;
  border:1px solid #d0d9e3;
  box-shadow:none;
}
button.action.alt:hover{background:#eef3f9}

footer{text-align:center;padding:3rem 1rem 3.5rem;font-size:.6rem;color:#93a3bd}

/* Responsive tweak */
@media(max-width:480px){
  .metric{flex:1 1 100%}
  #studyPlanEditor{min-height:140px}
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="images/Logo.png" alt="SATurn Bound Logo">
    <span>SATurn&nbsp;Bound</span>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="practice-tests.html">Tests</a>
    <a href="dashboard.html" style="background:rgba(255,255,255,.15)">Dashboard</a>
    <a href="aboutus.html">Our Team</a>
    <a href="login.html">Log In</a>
  </nav>
</header>

<main>
  <section class="dashboard-grid">

    <!-- Score Overview -->
    <div class="panel" id="scorePanel">
      <h3>Estimated Math Score</h3>
      <div class="small-label">CALCULATED FROM RECENT PRACTICE</div>

      <div class="score-gauge">
        <svg width="140" height="140">
          <defs>
            <linearGradient id="gradScore" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#54a6ff"/>
              <stop offset="100%" stop-color="#f27891"/>
            </linearGradient>
          </defs>
          <circle class="gauge-bg" cx="70" cy="70" r="56"></circle>
          <circle class="gauge-val" id="gaugeStroke" cx="70" cy="70" r="56"></circle>
        </svg>
        <div class="gauge-center">
            <div class="big" id="estScore">--</div>
            <div style="font-size:.6rem;letter-spacing:.08em;opacity:.75">/ 800</div>
        </div>
      </div>

      <div class="metric-row">
        <div class="metric">
          <strong id="accuracyOverall">--%</strong>
          <span>Weighted Accuracy</span>
          <div class="progress-bar"><span id="accuracyBar"></span></div>
        </div>
        <div class="metric">
          <strong id="attemptCount">0</strong>
          <span>Total Attempts</span>
        </div>
        <div class="metric">
          <strong id="recentImprovement">--</strong>
          <span>Recent Î” Score</span>
        </div>
      </div>

      <div id="difficultyBreakdown" style="display:flex;flex-wrap:wrap;gap:.4rem;"></div>
      <div id="scoreBadgeHolder"></div>
    </div>

    <!-- Focus & Recommendations -->
    <div class="panel" id="focusPanel">
      <h3>Today's Focus</h3>
      <div class="small-label">LOWEST ACCURACY AREAS</div>
      <div id="focusSkills">Not enough data yet.</div>
      <button class="action alt" id="refreshFocus" style="align-self:flex-start">Recalculate</button>
    </div>

    <!-- Skill Accuracy -->
    <div class="panel" id="skillsPanel">
      <h3>Skill Accuracy</h3>
      <div class="small-label">BY TAGGED SKILL</div>
      <div id="skillAccuracyContainer">Tag question skills to populate this.</div>
    </div>

    <!-- Attempts History -->
    <div class="panel" id="attemptsPanel">
      <h3>Recent Attempts</h3>
      <div class="small-label">LAST 6</div>
      <div style="overflow:auto">
        <table class="attempts-table" id="attemptsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Test</th>
              <th>Raw</th>
              <th>Weighted%</th>
              <th>Est Score</th>
              <th>Missed</th>
            </tr>
          </thead>
          <tbody id="attemptsBody">
            <tr><td colspan="6" style="text-align:center;opacity:.7;padding:1rem;">No attempts yet</td></tr>
          </tbody>
        </table>
      </div>
      <button class="action alt" id="clearLocal">Clear Local Data</button>
    </div>

    <!-- Personalized Study Plan -->
    <div class="panel" id="planPanel">
      <h3>Personal Study Plan</h3>
      <div class="small-label">EDIT & AUTO-SAVE</div>
      <div id="studyPlanEditor" contenteditable="true"></div>
      <div class="plan-actions">
        <button id="btnSavePlan">Save Now</button>
        <button id="btnPrintPlan">Print</button>
        <button id="btnTemplate">Insert Template</button>
        <button id="btnClearPlan" style="color:#d83232">Clear</button>
      </div>
      <div style="font-size:.6rem;opacity:.7;">Autosaves every 5s after changes. Last saved: <span id="planSavedTime">Never</span></div>
    </div>

  </section>
</main>

<footer>&copy; SATurn Bound 2025. All rights reserved.</footer>

<!-- Firebase (Optional for auth / remote attempts) -->
<script type="module">
/* ============ OPTIONAL FIREBASE (Auth) INIT (adjust versions if needed) ============ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
// OPTIONAL Firestore (uncomment if you will pull remote attempts)
// import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDedw_zEK-L-AoKO1WkeomLVztoRnYBXt4",
  authDomain: "saturn-bound.firebaseapp.com",
  projectId: "saturn-bound",
  storageBucket: "saturn-bound.appspot.com",
  messagingSenderId: "46027081851",
  appId: "1:46027081851:web:8402230dc2ff241c6cfade"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
// const db = getFirestore(app);

onAuthStateChanged(auth, user=>{
  // If you want to hide something for non-logged users, do it here.
});

/* ============ DASHBOARD LOGIC ============ */

/*** CONFIG ***/
const WEIGHTS = { easy:1.0, medium:1.4, hard:1.8 };
const PENALIZE_MISSES = false; // set true to apply 5% weight penalty
const MAX_SCORE = 800;
const ATTEMPT_KEYS = [
  // Add localStorage keys for each practice test you create
  'practiceTest2Results'
];

/*** DOM REFS ***/
const estScoreEl = document.getElementById('estScore');
const gaugeStroke = document.getElementById('gaugeStroke');
const accuracyOverallEl = document.getElementById('accuracyOverall');
const accuracyBar = document.getElementById('accuracyBar');
const attemptCountEl = document.getElementById('attemptCount');
const recentImprovementEl = document.getElementById('recentImprovement');
const attemptsBody = document.getElementById('attemptsBody');
const difficultyBreakdown = document.getElementById('difficultyBreakdown');
const scoreBadgeHolder = document.getElementById('scoreBadgeHolder');
const focusSkills = document.getElementById('focusSkills');
const refreshFocus = document.getElementById('refreshFocus');
const skillAccuracyContainer = document.getElementById('skillAccuracyContainer');
const clearLocalBtn = document.getElementById('clearLocal');

const planEditor = document.getElementById('studyPlanEditor');
const btnSavePlan = document.getElementById('btnSavePlan');
const btnPrintPlan = document.getElementById('btnPrintPlan');
const btnTemplate = document.getElementById('btnTemplate');
const btnClearPlan = document.getElementById('btnClearPlan');
const planSavedTime = document.getElementById('planSavedTime');

/*** LOAD ATTEMPTS (LOCAL) ***/
function loadLocalAttempts(){
  const out=[];
  ATTEMPT_KEYS.forEach(k=>{
    const raw = localStorage.getItem(k);
    if(!raw) return;
    const r = JSON.parse(raw);
    // we also need answers/difficulty meta maybe stored separately
    // Retrieve answers object
    const ansObj = r.answers || {};
    // For each answer we don't have difficulty tagging yet - default medium
    const questionMeta = r.questionMeta || {};
    out.push({
      key:k,
      date: new Date(r.timestamp || Date.now()),
      score: r.score,
      total: r.totalQuestions,
      answers: ansObj,
      questionMeta,
      pct: r.score / r.totalQuestions,
      // placeholder name inference
      testName: k.replace(/Results$/,'')
    });
  });
  return out.sort((a,b)=>b.date - a.date);
}

// OPTIONAL: merge remote
async function fetchFirestoreAttempts(user){
/*
  const attempts=[];
  if(!user) return attempts;
  const colRef = collection(db,'users',user.uid,'testAttempts');
  const snap = await getDocs(colRef);
  snap.forEach(docSnap=>{
    const d = docSnap.data();
    attempts.push({
      key: docSnap.id,
      date: d.timestamp?.toDate?.() || new Date(),
      score: d.score,
      total: d.totalQuestions,
      answers: d.answers || {},
      questionMeta: d.questionMeta || {},
      pct: d.score / d.totalQuestions,
      testName: docSnap.id
    });
  });
  return attempts;
*/
  return [];
}

/*** SCORING HELPERS ***/
function computeWeighted(attempt){
  // build arrays
  let totalWeight=0, correctWeight=0, incorrectWeight=0;
  Object.entries(attempt.answers).forEach(([qId,userAns])=>{
    const meta = attempt.questionMeta[qId] || {};
    const difficulty = (meta.difficulty || 'medium').toLowerCase();
    const weight = WEIGHTS[difficulty] || WEIGHTS.medium;
    const correctLetter = extractCorrectLetter(attempt, qId);
    if(!correctLetter) return;
    totalWeight += weight;
    if(userAns === correctLetter){
      correctWeight += weight;
    } else {
      incorrectWeight += weight;
    }
  });

  if(totalWeight === 0){
    return { weightedPct: 0, estScore: 0, correctWeight, totalWeight };
  }

  let ratio = correctWeight / totalWeight;
  if(PENALIZE_MISSES){
    ratio = Math.max(0, (correctWeight - 0.05 * incorrectWeight) / totalWeight);
  }
  const estScore = Math.round(MAX_SCORE * ratio);
  return { weightedPct: ratio, estScore, correctWeight, totalWeight };
}

// Try to get correct letter from stored answers or meta.
// Presently your practice page does not store correct answers per question with attempt; we approximate
// by using score proportion only if detailed answers are not stored.
// (For precision, store a per-question correct answer map in attempt.questionMeta.)
function extractCorrectLetter(attempt, qId){
  // If meta includes correct answer
  if(attempt.questionMeta[qId]?.correct) return attempt.questionMeta[qId].correct;
  // Fallback: If we can't, we *cannot* know which are correct individually -> return userAns so weightedPct ~ raw
  // (Better: modify practice page to save per-question correctness.)
  return attempt.answers[qId]; 
}

/*** BUILD DASHBOARD DATA ***/
let allAttempts = loadLocalAttempts(); // will merge remote if you later call

function aggregate(){
  if(!allAttempts.length){
    estScoreEl.textContent='--';
    return;
  }

  // Weighted stats across all attempts (last N? choose)
  const consider = allAttempts.slice(0,10); // last 10
  let totalW=0, correctW=0;
  let difficultyTotals={}, difficultyCorrect={};
  let skillTotals={}, skillCorrect={};

  consider.forEach(at=>{
    Object.entries(at.answers).forEach(([qId,userAns])=>{
      const meta = at.questionMeta[qId] || {};
      const diff = (meta.difficulty || 'medium').toLowerCase();
      const skill = meta.skill || 'Untagged';
      const w = WEIGHTS[diff] || WEIGHTS.medium;
      const correctLetter = extractCorrectLetter(at,qId);
      const isCorrect = (userAns === correctLetter);
      totalW += w;
      difficultyTotals[diff]=(difficultyTotals[diff]||0)+w;
      skillTotals[skill]=(skillTotals[skill]||0)+w;
      if(isCorrect){
        correctW += w;
        difficultyCorrect[diff]=(difficultyCorrect[diff]||0)+w;
        skillCorrect[skill]=(skillCorrect[skill]||0)+w;
      }
    });
  });

  const weightedPct = totalW? (correctW/totalW):0;
  const estScore = Math.round(MAX_SCORE * weightedPct);
  estScoreEl.textContent=estScore;
  // Gauge
  const circumference = 2*Math.PI*56;
  const offset = circumference * (1 - weightedPct);
  gaugeStroke.style.strokeDasharray = circumference;
  gaugeStroke.style.strokeDashoffset = offset;

  accuracyOverallEl.textContent = (weightedPct*100).toFixed(1)+'%';
  accuracyBar.style.width = (weightedPct*100).toFixed(1)+'%';
  attemptCountEl.textContent = allAttempts.length;

  // Improvement
  if(allAttempts.length>=2){
    const prev = computeWeighted(allAttempts[1]);
    const latest = computeWeighted(allAttempts[0]);
    const delta = latest.estScore - prev.estScore;
    recentImprovementEl.textContent = (delta>=0?'+':'')+delta;
    recentImprovementEl.style.color = delta>=0 ? '#1c9c55' : '#d83232';
  } else {
    recentImprovementEl.textContent = '--';
  }

  // Difficulty pills
  difficultyBreakdown.innerHTML='';
  Object.keys(WEIGHTS).forEach(diff=>{
    const tot = difficultyTotals[diff]||0;
    if(!tot) return;
    const corr = difficultyCorrect[diff]||0;
    const pct = (corr/tot*100).toFixed(0);
    const el = document.createElement('div');
    el.className='badge';
    el.style.background='rgba(255,255,255,.15)';
    el.style.color='#fff';
    el.textContent=diff.charAt(0).toUpperCase()+diff.slice(1)+': '+pct+'%';
    difficultyBreakdown.appendChild(el);
  });

  // Badge summary
  scoreBadgeHolder.innerHTML='';
  const badge=document.createElement('div');
  badge.className='badge '+(estScore>=650?'good': estScore>=500?'warn':'bad');
  badge.textContent= estScore>=650?'On Track': estScore>=500?'Grow Zone':'Foundation';
  scoreBadgeHolder.appendChild(badge);

  /* Skill Accuracy */
  if(Object.keys(skillTotals).length){
    skillAccuracyContainer.innerHTML='';
    Object.entries(skillTotals).forEach(([skill,wTot])=>{
      const wCorr = skillCorrect[skill]||0;
      const p = wCorr / wTot;
      const row = document.createElement('div');
      row.className='skill-bar-row';
      row.innerHTML=`
        <div class="skill-label">
          <span>${skill}</span>
          <span>${(p*100).toFixed(0)}%</span>
        </div>
        <div class="skill-progress"><span style="width:${(p*100).toFixed(2)}%"></span></div>
      `;
      skillAccuracyContainer.appendChild(row);
    });
  } else {
    skillAccuracyContainer.textContent='Tag skills in question metadata to see breakdown.';
  }

  // Focus skills (lowest three)
  buildFocus(skillTotals, skillCorrect);
}

/* Build focus suggestions */
function buildFocus(skillTotals, skillCorrect){
  const container = focusSkills;
  container.innerHTML='';
  const skills = Object.keys(skillTotals);
  if(!skills.length){ container.textContent='Not enough data yet.'; return; }
  const arr = skills.map(s=>{
    const pct = (skillCorrect[s]||0)/(skillTotals[s]||1);
    return {skill:s,pct};
  }).sort((a,b)=>a.pct-b.pct);
  const top = arr.slice(0,3);
  top.forEach(item=>{
    const pill = document.createElement('div');
    const cls = item.pct<0.5?'low': (item.pct<0.75?'mid':'good');
    pill.className='focus-pill '+cls;
    pill.textContent= item.skill+' â€¢ '+(item.pct*100).toFixed(0)+'%';
    container.appendChild(pill);
  });
  if(arr.length>3){
    const hint=document.createElement('div');
    hint.style.fontSize='.55rem';
    hint.style.opacity='.7';
    hint.textContent='Focus on weakest 3 first, then re-test.';
    container.appendChild(hint);
  }
}

/*** Attempts Table ***/
function renderAttempts(){
  attemptsBody.innerHTML='';
  if(!allAttempts.length){
    attemptsBody.innerHTML='<tr><td colspan="6" style="text-align:center;opacity:.7;padding:1rem;">No attempts yet</td></tr>';
    return;
  }
  allAttempts.slice(0,6).forEach(a=>{
    const w = computeWeighted(a);
    const missed = a.total - a.score;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${a.date.toLocaleDateString()}</td>
      <td>${a.testName}</td>
      <td>${a.score}/${a.total}</td>
      <td>${(w.weightedPct*100).toFixed(1)}%</td>
      <td>${w.estScore}</td>
      <td>${missed}</td>
    `;
    attemptsBody.appendChild(tr);
  });
}

/*** CLEAR LOCAL DATA ***/
clearLocalBtn.onclick=()=>{
  if(!confirm('Clear only local cached attempts? (Firebase data unaffected)')) return;
  ATTEMPT_KEYS.forEach(k=>localStorage.removeItem(k));
  ['answers','flagged','submitted','results'].forEach(s=>localStorage.removeItem('practiceTest2_'+s));
  allAttempts = loadLocalAttempts();
  renderAttempts();
  aggregate();
};

/*** STUDY PLAN PERSISTENCE ***/
const PLAN_KEY='dashboard_study_plan_v1';
const PLAN_TIME_KEY='dashboard_study_plan_saved_at';
let planDirty=false;
function loadPlan(){
  const saved = localStorage.getItem(PLAN_KEY);
  if(saved) planEditor.innerHTML = saved;
  const t = localStorage.getItem(PLAN_TIME_KEY);
  if(t) planSavedTime.textContent=new Date(+t).toLocaleTimeString();
}
loadPlan();

function savePlan(){
  localStorage.setItem(PLAN_KEY, planEditor.innerHTML);
  const now=Date.now();
  localStorage.setItem(PLAN_TIME_KEY, now);
  planSavedTime.textContent=new Date(now).toLocaleTimeString();
  planDirty=false;
}

planEditor.addEventListener('input',()=>{planDirty=true;});

setInterval(()=>{ if(planDirty) savePlan(); },5000);

btnSavePlan.onclick=savePlan;
btnPrintPlan.onclick=()=>{
  const win = window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>Study Plan</title>
  <style>body{font-family:Inter,Arial,sans-serif;padding:24px;line-height:1.5;font-size:15px;color:#111}h1{margin-top:0}</style>
  </head><body><h1>Personal Study Plan</h1>${planEditor.innerHTML}</body></html>`);
  win.document.close();win.focus();win.print();
};

btnTemplate.onclick=()=>{
  if(planEditor.innerText.trim().length>0 && !confirm('Replace existing content with template (append)?')) return;
  planEditor.innerHTML += `
  <h4>Weekly Structure</h4>
  <ul>
    <li><strong>Mon:</strong> 30m Algebra (linear eqns) + 10 mixed hard.</li>
    <li><strong>Tue:</strong> 25m Nonlinear functions + review errors.</li>
    <li><strong>Wed:</strong> Full timed mini-set (20 Q) â€“ pace focus.</li>
    <li><strong>Thu:</strong> Data & Probability drill + 5 hard geometry.</li>
    <li><strong>Fri:</strong> Mixed review (weakest 3 skills).</li>
    <li><strong>Sat:</strong> Full-length practice (if time) / else adapt retest.</li>
    <li><strong>Sun:</strong> Light recap + flashcards.</li>
  </ul>
  <h4>Priority Weak Skills</h4>
  <ol>
    <li>Placeholder Skill A</li>
    <li>Placeholder Skill B</li>
    <li>Placeholder Skill C</li>
  </ol>
  <h4>Score Targets</h4>
  <p>Next checkpoint: +40 points in 2 weeks (raise weighted accuracy â‰¥ 70%).</p>
  `;
  planDirty=true;
};

btnClearPlan.onclick=()=>{
  if(!confirm('Clear the study plan?')) return;
  planEditor.innerHTML='';
  savePlan();
};

/*** Re-Focus Button ***/
refreshFocus.onclick=aggregate;

/*** INIT RENDER ***/
renderAttempts();
aggregate();

/* EXAMPLE: If you later also load remote attempts, you could:
(async ()=>{
  const remote = await fetchFirestoreAttempts(auth.currentUser);
  allAttempts = [...remote, ...allAttempts].sort((a,b)=>b.date - a.date);
  renderAttempts(); aggregate();
})();
*/
</script>

</body>
</html>
